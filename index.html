<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Where is Omari?</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background: #0a0a0a;
            color: #ffffff;
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
        }
        
		/* Enhanced particle system */
		.particles {
			position: fixed;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			pointer-events: none;
			z-index: 1;
		}

		.particle {
			position: absolute;
			border-radius: 50%;
			pointer-events: none;
		}

		.particle-small {
			width: 1px;
			height: 1px;
			background: rgba(255, 255, 255, 0.9);
			box-shadow: 0 0 2px rgba(255, 255, 255, 0.8);
			animation: floatUp 4s infinite linear;
		}

		.particle-medium {
			width: 2px;
			height: 2px;
			background: rgba(100, 200, 255, 0.95);
			box-shadow: 0 0 4px rgba(100, 200, 255, 0.7);
			animation: floatUp 6s infinite linear;
		}

		.particle-large {
			width: 3px;
			height: 3px;
			background: rgba(255, 100, 200, 0.9);
			box-shadow: 0 0 6px rgba(255, 100, 200, 0.6);
			animation: floatUp 8s infinite linear;
		}

		@keyframes floatUp {
			0% {
				transform: translateY(100vh) rotate(0deg);
				opacity: 0;
			}
			10% {
				opacity: 1;
			}
			90% {
				opacity: 1;
			}
			100% {
				transform: translateY(-10vh) rotate(360deg);
				opacity: 0;
			}
		}

        /* --- NEW: Login Screen Styles --- */
        .login-splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(10, 10, 10, 0.7);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: opacity 0.5s ease;
        }

        .login-content {
            background: rgba(20, 20, 20, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 40px;
            border-radius: 15px;
            text-align: center;
            width: 90%;
            max-width: 380px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .login-title {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .login-subtitle {
            font-size: 1rem;
            font-weight: 300;
            color: #aaa;
            margin-bottom: 30px;
        }

        .login-input {
            width: 100%;
            padding: 12px 15px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: white;
            font-size: 1rem;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }

        .login-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 15px rgba(102, 126, 234, 0.4);
        }

        .login-button {
            width: 100%;
            padding: 12px 15px;
            background: linear-gradient(90deg, #8A2BE2, #4B0082);
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .login-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(138, 43, 226, 0.4);
        }

        .login-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .login-status, .login-error {
            margin-top: 20px;
            font-size: 0.9rem;
            min-height: 1.2em;
        }
        .login-status { color: #888; }
        .login-error { color: #ff6b6b; }
        
        #passwordResetLink {
            font-size: 0.9rem;
            color: #888;
            text-decoration: none;
            margin-top: 15px;
            display: inline-block;
            transition: color 0.3s;
        }

        #passwordResetLink:hover {
            color: #ccc;
        }

        #passwordResetModal {
            display: none; /* Controlled by JS */
        }
        
        /* Main container */
        .container {
            position: relative;
            z-index: 10;
            min-height: 100vh;
            display: flex; /* Changed from 'none' to 'flex' by JS */
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 2rem;
            text-align: center;
        }
        
        /* Stylized "Omari is probably" */
		.status-prefix {
			font-size: clamp(2rem, 6vw, 4rem);
			font-weight: 300;
			margin-bottom: 2rem;
			opacity: 0;
			animation: fadeInUp 1s ease-out 0.3s forwards, gradientCycle 5s linear infinite;
			background: linear-gradient(to right, hsl(300, 80%, 70%), hsl(270, 80%, 61%), hsl(235, 85%, 55%), hsl(300, 80%, 70%));
			background-size: 300% 300%;
			-webkit-background-clip: text;
			background-clip: text;
			-webkit-text-fill-color: transparent;
			position: relative;
		}

		@keyframes gradientCycle {
			0% { background-position: 150% 0%, 0% 50%; }
			33% { background-position: 100% 100%, 50% 50%; }
			66% { background-position: 50% 50%, 100% 0%; }
			100% { background-position: 0% 0%, 150% 50%; }
		}
        
        .status-prefix::after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 80px;
            height: 2px;
            background: linear-gradient(90deg, transparent, #667eea, transparent);
            opacity: 0.6;
        }
        
        /* Main status display */
        .status-main {
            font-size: clamp(2.5rem, 8vw, 6rem);
            font-weight: 800;
            line-height: 1.1;
            margin-bottom: 2rem;
            opacity: 0;
            animation: fadeInUp 1s ease-out 0.6s forwards;
            color: #ffffff;
            text-shadow: 0 0 30px rgba(255, 255, 255, 0.3);
        }
        
        /* Status details */
        .status-details {
            font-size: clamp(1rem, 3vw, 1.5rem);
            font-weight: 400;
            color: #aaa;
            opacity: 0;
            animation: fadeInUp 1s ease-out 0.9s forwards;
        }
        
        /* Loading state */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            font-size: 1.2rem;
            color: #666;
        }
        
        .loading-dot {
            width: 8px;
            height: 8px;
            background: #666;
            border-radius: 50%;
            animation: loadingDots 1.5s ease-in-out infinite;
        }
        
        .loading-dot:nth-child(2) { animation-delay: 0.2s; }
        .loading-dot:nth-child(3) { animation-delay: 0.4s; }
        
        @keyframes loadingDots {
            0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
            40% { transform: scale(1.2); opacity: 1; }
        }
        
        /* Animations */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* Status change animation */
        .status-change {
            animation: statusChange 0.6s ease-out;
        }
        
        @keyframes statusChange {
            0% {
                opacity: 0;
                transform: translateY(20px);
            }
            100% {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Details fade animations */
        .details-fade-out {
            animation: detailsFadeOut 0.3s ease-out forwards;
        }
        
        .details-fade-in {
            animation: detailsFadeIn 0.4s ease-out forwards;
        }
        
        @keyframes detailsFadeOut {
            from {
                opacity: 1;
            }
            to {
                opacity: 0;
            }
        }
        
        @keyframes detailsFadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }
        
        /* Responsive design */
        @media (max-width: 768px) {
            .container { padding: 1rem; }
            .login-content { padding: 30px 20px; }
        }
    </style>
</head>
<body>
    <!-- Enhanced particle background -->
    <div class="particles" id="particles"></div>
    
    <!-- NEW: Login Screen -->
    <div class="login-splash-screen" id="loginSplashScreen">
        <div class="login-content">
            <h1 class="login-title">Where is Omari?</h1>
            <p class="login-subtitle">Please sign in to continue</p>
            <div id="loginForm">
                <input type="email" id="emailInput" class="login-input" placeholder="Email">
                <input type="password" id="passwordInput" class="login-input" placeholder="Password">
                <button id="loginButton" class="login-button" onclick="signIn()">Sign In</button>
                <div id="loginError" class="login-error"></div>
                <a href="#" id="passwordResetLink" onclick="showPasswordResetForm(); return false;">Forgot Password?</a>
            </div>
            <div id="loginStatus" class="login-status" style="display: none;"></div>
        </div>
    </div>
    
    <!-- NEW: Password Reset Modal (hidden by default) -->
    <div class="login-splash-screen" id="passwordResetModal">
        <div class="login-content">
            <h1 class="login-title">Reset Password</h1>
            <p class="login-subtitle">Enter your email to receive a reset link</p>
            <input type="email" id="resetEmailInput" class="login-input" placeholder="Email Address">
            <button class="login-button" onclick="sendPasswordReset()">Send Link</button>
            <div id="resetMessage" class="login-status" style="min-height: 1.2em; margin-top: 15px;"></div>
            <a href="#" id="cancelResetLink" onclick="hidePasswordResetForm(); return false;" style="font-size: 0.9rem; color: #888; text-decoration: none; margin-top: 15px; display: inline-block;">Cancel</a>
        </div>
    </div>

    <!-- Main content (initially hidden) -->
    <div class="container" id="mainContainer" style="display: none;">
        <div class="status-prefix">Omari is probably</div>
        
        <div class="status-main" id="statusMain">
            <div class="loading" id="loadingState">
                <span>fetching timetable</span>
                <div class="loading-dot"></div>
                <div class="loading-dot"></div>
                <div class="loading-dot"></div>
            </div>
        </div>
        
        <div class="status-details" id="statusDetails">Please wait...</div>
    </div>

    <script>
        // --- START: Firebase Integration and Authentication ---

        const mainContainer = document.getElementById('mainContainer');
        const loginSplashScreen = document.getElementById('loginSplashScreen');
        const loginForm = document.getElementById('loginForm');
        const loginStatus = document.getElementById('loginStatus');
        const loginError = document.getElementById('loginError');
        const loginButton = document.getElementById('loginButton');
        const passwordInput = document.getElementById('passwordInput');

		function signIn() {
			const email = document.getElementById('emailInput').value;
			const password = passwordInput.value;
			
			if (!email || !password) {
				loginError.textContent = "Please enter both email and password.";
				return;
			}

			loginButton.disabled = true;
			loginError.textContent = '';
			loginStatus.textContent = 'Authenticating...';
			loginStatus.style.display = 'block';

			console.log('Attempting to sign in user:', email);

			firebase.auth().signInWithEmailAndPassword(email, password)
				.then((userCredential) => {
					console.log('Sign in successful for:', userCredential.user.email);
					// Don't call initializeApp here - it will be called by onAuthStateChanged
					loginStatus.textContent = 'Authentication successful...';
				})
				.catch((error) => {
					console.error('Sign in error:', error);
					loginStatus.style.display = 'none';
					loginError.textContent = getUserFriendlyAuthError(error);
					loginButton.disabled = false;
				});
		}
        
        passwordInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                signIn();
            }
        });

        function getUserFriendlyAuthError(error) {
            switch (error.code) {
                case 'auth/invalid-login-credentials':
                case 'auth/user-not-found':
                case 'auth/wrong-password':
                case 'auth/invalid-email':
                    return "Incorrect email or password. Please try again.";
                case 'auth/too-many-requests':
                    return "Access temporarily disabled. Please try again later.";
                case 'auth/network-request-failed':
                    return "Network error. Please check your connection.";
                default:
                    return "Login error: " + error.message;
            }
        }

        // Password Reset Functions
        function showPasswordResetForm() {
            document.getElementById('passwordResetModal').style.display = 'flex';
        }
        function hidePasswordResetForm() {
            document.getElementById('passwordResetModal').style.display = 'none';
        }
        function sendPasswordReset() {
            const email = document.getElementById('resetEmailInput').value;
            const messageElement = document.getElementById('resetMessage');
            if (!email) {
                messageElement.textContent = "Please enter your email.";
                return;
            }
            firebase.auth().sendPasswordResetEmail(email)
                .then(() => {
                    messageElement.textContent = "Password reset email sent!";
                    setTimeout(() => hidePasswordResetForm(), 3000);
                })
                .catch((error) => {
                    messageElement.textContent = "Error: " + error.message;
                });
        }
        
        // Main function to initialize app after login
        function initializeApp() {
			console.log('initializeApp called for user:', firebase.auth().currentUser?.email);
			
			loginStatus.textContent = 'Loading timetable...';
			loginStatus.style.display = 'block';

			// Fetch timetable first, then duty tracker (sequential, not parallel)
			fetchAndProcessTimetable()
				.then(() => {
					console.log('Timetable loaded successfully, now loading duty tracker...');
					loginStatus.textContent = 'Loading duty tracker...';
					return fetchDutyTracker();
				})
				.then(() => {
					console.log('Both timetable and duty tracker loaded successfully');
					loginStatus.textContent = 'Data loaded successfully!';
					
					// Hide login screen with fade out
					loginSplashScreen.style.opacity = '0';
					setTimeout(() => {
						loginSplashScreen.style.display = 'none';
					}, 500);

					// Show main container
					mainContainer.style.display = 'flex';
					
					// Start the real-time updates
					startRealTimeUpdates();
				})
				.catch(error => {
					console.error("Initialization failed:", error);
					
					// Show error to user
					loginStatus.style.display = 'none';
					loginError.textContent = 'Error loading data: ' + error.message;
					loginButton.disabled = false;
					
					// Log more details for debugging
					console.error('Full error details:', {
						message: error.message,
						stack: error.stack,
						name: error.name
					});
				});
		}
        
        // Function to fetch duty tracker from Firebase
		function fetchDutyTracker() {
			return new Promise((resolve, reject) => {
				loginStatus.textContent = 'Loading duty tracker...';
				
				// Reference to your storage bucket's tracker folder (EXACT same pattern as DLR app)
				const storageRef = firebase.storage().ref('tracker');
				
				// List all files in the tracker folder (EXACT same approach)
				storageRef.listAll()
					.then((result) => {
						console.log('Files found in tracker folder:', result.items.length);
						
						if (result.items.length === 0) {
							throw new Error('No files found in tracker folder');
						}
						
						// Find the duty-tracker.txt file
						const trackerFile = result.items.find(item => item.name === 'duty-tracker.txt');
						if (!trackerFile) {
							throw new Error('duty-tracker.txt not found in tracker folder');
						}
						
						console.log('Found duty-tracker.txt, getting download URL...');
						
						// Get download URL and fetch (EXACT same pattern as DLR app)
						return trackerFile.getDownloadURL();
					})
					.then((url) => {
						console.log('Download URL obtained:', url);
						
						// Fetch the file content (EXACT same pattern as DLR app)
						return fetch(url);
					})
					.then(response => {
						console.log('Fetch response:', response.status, response.statusText);
						if (!response.ok) throw new Error(`HTTP ${response.status}: ${response.statusText}`);
						return response.text();
					})
					.then(text => {
						console.log('Duty tracker loaded successfully. Length:', text.length);
						dutyData = text;
						resolve();
					})
					.catch(error => {
						console.error('Error fetching duty tracker:', error);
						reject(error);
					});
			});
		}

        // --- END: Firebase Integration and Authentication ---


        // Enhanced particle system
		function createParticles() {
			const particlesContainer = document.getElementById('particles');
			const particleCount = 300;
			
			for (let i = 0; i < particleCount; i++) {
				const particle = document.createElement('div');
				const types = ['particle-small', 'particle-medium', 'particle-large'];
				const typeWeights = [0.6, 0.3, 0.1];
				
				let randomType = 'particle-small';
				const rand = Math.random();
				if (rand > typeWeights[0] + typeWeights[1]) {
					randomType = 'particle-large';
				} else if (rand > typeWeights[0]) {
					randomType = 'particle-medium';
				}
				
				particle.className = `particle ${randomType}`;
				particle.style.left = Math.random() * 100 + '%';
				particle.style.animationDelay = Math.random() * 15 + 's';
				
				const baseDuration = Math.random() * 4 + 4;
				particle.style.animationDuration = baseDuration + 's';
				particle.dataset.baseDuration = baseDuration;
				
				particlesContainer.appendChild(particle);
			}
		}
		
		function updateParticleSpeed(status) {
			const particles = document.querySelectorAll('.particle');
			let targetSpeedMultiplier = 1;
			
			if (status.main.includes('at ')) targetSpeedMultiplier = 0.1;
			else if (status.main.includes('approaching ')) targetSpeedMultiplier = 0.5;
			else if (status.main.includes('departing ')) targetSpeedMultiplier = 1;
			else if (status.main.includes('between ')) targetSpeedMultiplier = 3;
			else if (status.main.includes('on break') || status.main.includes('not on the DLR')) targetSpeedMultiplier = 0.05;
			
			particles.forEach(particle => {
				const animations = particle.getAnimations();
				if (animations.length > 0) {
					const animation = animations[0];
					const currentRate = particle.dataset.currentRate ? parseFloat(particle.dataset.currentRate) : 1;
					
					particle.dataset.targetRate = targetSpeedMultiplier;
					particle.dataset.startRate = currentRate;
					particle.dataset.transitionStart = Date.now();
					
					if (particle.rateTransition) clearInterval(particle.rateTransition);
					
					particle.rateTransition = setInterval(() => {
						const elapsed = Date.now() - parseFloat(particle.dataset.transitionStart);
						const duration = 10000;
						const progress = Math.min(elapsed / duration, 1);
						const easedProgress = 1 - Math.pow(1 - progress, 3);
						const startRate = parseFloat(particle.dataset.startRate);
						const targetRate = parseFloat(particle.dataset.targetRate);
						const newRate = startRate + (targetRate - startRate) * easedProgress;
						
						animation.playbackRate = newRate;
						particle.dataset.currentRate = newRate;
						
						if (progress >= 1) {
							clearInterval(particle.rateTransition);
							particle.rateTransition = null;
						}
					}, 50);
				}
			});
		}
        
        // Data storage
        let csvData = null;
        let dutyData = null;
        let parsedCsvData = null;
        let runTransitions = {};
        let updateInterval = null;
        let previousStatus = { main: null, details: null };
        
        let updateBuffer = {
            timer: null,
            pendingUpdate: null
        };
        
        // Start real-time updates
        function startRealTimeUpdates() {
            if (updateInterval) clearInterval(updateInterval);
            updateStatusRealTime();
            updateInterval = setInterval(updateStatusRealTime, 1000);
        }
        
        function updateStatusRealTime() {
            if (!parsedCsvData || !dutyData) return;
            
            const currentTimeInTimezone = getCurrentTimeInTimezone();
            const timeStr = currentTimeInTimezone.toTimeString().substring(0, 8);
            const operatingDate = getOperatingDate();
            
            const status = calculateCurrentStatus(operatingDate, timeStr, currentTimeInTimezone);
            
            const isCountdownUpdate = isOnlyCountdownChange(previousStatus, status);
            
            if (status.main !== previousStatus.main || status.details !== previousStatus.details) {
                displayStatus(status.main, status.details, !isCountdownUpdate);
                previousStatus = { main: status.main, details: status.details };
            }
        }
        
        function isOnlyCountdownChange(oldStatus, newStatus) {
            if (!oldStatus.details || !newStatus.details || oldStatus.main !== newStatus.main) return false;
            
            const oldMinutes = oldStatus.details.match(/departing in (\d+) minute/);
            const newMinutes = newStatus.details.match(/departing in (\d+) minute/);
            
            if (oldMinutes && newMinutes) {
                const oldRest = oldStatus.details.replace(/departing in \d+ minute[s]?/, 'departing in X minute');
                const newRest = newStatus.details.replace(/departing in \d+ minute[s]?/, 'departing in X minute');
                return oldRest === newRest;
            }
            return false;
        }
        
        // TIMEZONE SETTING
        const SYSTEM_TIMEZONE = "America_Los_Angeles";
        
        function getCurrentTimeInTimezone(dateTime = null) {
            const now = dateTime || new Date();
            try {
                const localTimeString = now.toLocaleString("en-US", { timeZone: SYSTEM_TIMEZONE, year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false });
                const [datePart, timePart] = localTimeString.split(', ');
                const [month, day, year] = datePart.split('/');
                const [hour, minute, second] = timePart.split(':');
                return new Date(year, month - 1, day, hour, minute, second);
            } catch (error) {
                console.error(`[ERROR] getCurrentTimeInTimezone failed:`, error);
                return new Date();
            }
        }
        
        function getOperatingDate(dateTime = null) {
            const localDateTime = getCurrentTimeInTimezone(dateTime || new Date());
            if (localDateTime.getHours() < 3) {
                localDateTime.setDate(localDateTime.getDate() - 1);
            }
            return localDateTime.toISOString().split('T')[0];
        }
        
        function convertDutyTimeToDateTime(dutyDate, dutyTime) {
            const [hours, minutes] = dutyTime.split(':').map(Number);
            const actualHours = hours >= 24 ? hours - 24 : hours;
            const isNextDay = hours >= 24;
            const dutyDateTime = new Date(dutyDate + 'T' + actualHours.toString().padStart(2, '0') + ':' + minutes.toString().padStart(2, '0') + ':00');
            if (isNextDay) dutyDateTime.setDate(dutyDateTime.getDate() + 1);
            return dutyDateTime;
        }
        
        const locationMapping = {
            'ABR': 'Abbey Road', 'ALS': 'All Saints', 'BAN': 'Bank', 'BEC': 'Beckton', 'BEP': 'Beckton Park', 'BLA': 'Blackwall', 'BOC': 'Bow Church', 'CAW': 'Canary Wharf', 'CAT': 'Canning Town', 'CRO': 'Crossharbour', 'CUH': 'Custom House', 'CUS': 'Cutty Sark', 'CYP': 'Cyprus', 'DEB': 'Deptford Bridge', 'DER': 'Devons Road', 'EAI': 'East India', 'ELR': 'Elverson Road', 'GAR': 'Gallions Reach', 'GRE': 'Greenwich', 'HEQ': 'Heron Quays', 'ISG': 'Island Gardens', 'KGV': 'King George V', 'LAP': 'Langdon Park', 'LEW': 'Lewisham', 'LIM': 'Limehouse', 'LCA': 'London City Airport', 'MUD': 'Mudchute', 'PDK': 'Pontoon Dock', 'POP': 'Poplar', 'PRR': 'Prince Regent', 'PML': 'Pudding Mill Lane', 'ROA': 'Royal Albert', 'ROV': 'Royal Victoria', 'SHA': 'Shadwell', 'SOQ': 'South Quay', 'STL': 'Star Lane', 'SHS': 'Stratford High Street', 'STI': 'Stratford International', 'STR': 'Stratford', 'TOG': 'Tower Gateway', 'WEH': 'West Ham', 'WIQ': 'West India Quay', 'WST': 'West Silvertown', 'WES': 'Westferry', 'WOA': 'Woolwich Arsenal'
        };
        
		// Timetable Fetching Logic (wrapped in a Promise)
        function fetchAndProcessTimetable() {
            return new Promise(async (resolve, reject) => {
                const pathsUrl = 'https://raw.githubusercontent.com/dlrttbl/dlrttbl.github.io/refs/heads/main/paths.txt';
                try {
                    const response = await fetch(pathsUrl, { cache: 'no-store' });
                    if (!response.ok) throw new Error(`Failed to fetch paths.txt: ${response.statusText}`);
                    const text = await response.text();
                    const lines = text.split('\n').filter(line => line.trim() !== '');

                    let currentEntry = {};
                    const timetableEntries = [];
                    for (const line of lines) {
                        const trimmedLine = line.trim();
                        if (trimmedLine.startsWith('Name:')) {
                            if (Object.keys(currentEntry).length > 0) timetableEntries.push({...currentEntry});
                            currentEntry = { name: trimmedLine.substring(5).trim() };
                        } else if (trimmedLine.startsWith('Applies:')) {
                            currentEntry.applies = trimmedLine.substring(8).trim();
                        } else if (trimmedLine.startsWith('URL:')) {
                            currentEntry.url = trimmedLine.substring(4).trim();
                        }
                    }
                    if (Object.keys(currentEntry).length > 0) timetableEntries.push(currentEntry);

                    if (timetableEntries.length === 0) throw new Error('No valid timetables found in paths.txt');

                    const sortedEntries = sortTimetablesByApplicability(timetableEntries);
                    const applicableTimetable = sortedEntries[0];
                    console.log(`[INFO] Using timetable: '${applicableTimetable.name}' from URL: ${applicableTimetable.url}`);

                    const csvResponse = await fetch(applicableTimetable.url, { cache: 'no-store' });
                    if (!csvResponse.ok) throw new Error(`Failed to fetch timetable CSV: ${csvResponse.statusText}`);
                    const csvText = await csvResponse.text();

                    csvData = csvText;
                    parsedCsvData = parseCSVData(csvData);
                    runTransitions = detectRunTransitions(csvData);
                    console.log('Timetable data loaded and parsed automatically.');
                    
                    resolve();

                } catch (error) {
                    console.error('[ERROR] Automatic timetable fetching failed:', error);
                    alert('Could not automatically load the DLR timetable. Please check your internet connection and refresh. Error: ' + error.message);
                    document.getElementById('statusMain').textContent = 'Error';
                    document.getElementById('statusDetails').textContent = 'Failed to load timetable.';
                    reject(error);
                }
            });
        }
        
        function parseDateRange(dateStr) {
			dateStr = dateStr.replace(/['"]/g, '');
			if (dateStr.includes('/')) {
				const [start, end] = dateStr.split('/').map(d => new Date(d.trim()));
				return { start, end };
			}
			const date = new Date(dateStr);
			return { start: date, end: date };
		}
		function getDayName(date) { return date.toLocaleDateString('en-US', { weekday: 'long' }); }
		function isDateInRange(date, rangeStr) {
			const ranges = rangeStr.split(',').map(r => r.trim().replace(/['"]/g, ''));
			return ranges.some(range => {
				if (['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'].includes(range)) {
					return getDayName(date) === range;
				}
				const dateRange = parseDateRange(range);
				return date >= dateRange.start && date <= dateRange.end;
			});
		}
		function sortTimetablesByApplicability(entries) {
			const operatingDateTime = getCurrentTimeInTimezone();
			const dayNames = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
			return entries.sort((a, b) => {
				const aApplies = a.applies.split(',').map(s => s.trim().replace(/['"]/g, ''));
				const bApplies = b.applies.split(',').map(s => s.trim().replace(/['"]/g, ''));
				const aHasSpecificDate = aApplies.some(range => !dayNames.includes(range));
				const bHasSpecificDate = bApplies.some(range => !dayNames.includes(range));
				const aAppliesNow = aApplies.some(range => isDateInRange(operatingDateTime, range));
				const bAppliesNow = bApplies.some(range => isDateInRange(operatingDateTime, range));
				if (aAppliesNow && bAppliesNow) {
					if (aHasSpecificDate && !bHasSpecificDate) return -1;
					if (!aHasSpecificDate && bHasSpecificDate) return 1;
				}
				if (aAppliesNow && !bAppliesNow) return -1;
				if (!aAppliesNow && bAppliesNow) return 1;
				return a.name.localeCompare(b.name);
			});
		}
        
        function parseCSVData(csvText) {
            const lines = csvText.split('\n').filter(line => line.trim() !== '');
            const runData = {};
            const junctions = ['JRMS', 'JRMX', 'JCAW', 'JWEM', 'JCRO', 'JC2M', 'JC3M', 'JC4M', 'JROM', 'JWEX', 'JCTM', 'JCTX', 'JWIQ', 'JNQX', 'JNQM', 'JWSX', 'JWSM', 'ISP2', 'ISP3'];
            
            lines.forEach((line) => {
                const parts = line.split(',');
                if (parts.length >= 7) {
                    const runNumber = parts[1].trim();
                    const locationCode = parts[4].trim();
                    
                    if (!junctions.includes(locationCode)) {
                        if (!runData[runNumber]) {
                            runData[runNumber] = [];
                        }
                        
                        let location = '';
                        let platform = '';
                        
                        if (locationCode === 'BANH') {
                            location = 'Bank Headshunt';
                        } else {
                            const codePrefix = locationCode.slice(0, 3);
                            platform = locationCode.slice(3);
                            
                            if (locationMapping[codePrefix]) {
                                location = locationMapping[codePrefix];
                                if (['LEW', 'BEC', 'STI', 'WOA'].includes(codePrefix) || locationCode === 'STR4B') {
                                    platform = '';
                                }
                            } else {
                                location = locationCode;
                                platform = '';
                            }
                        }
                        
                        runData[runNumber].push({
                            location,
                            platform,
                            arrivalTime: parts[5].trim(),
                            departureTime: parts[6].trim(),
                            locationCode
                        });
                    }
                }
            });
            return runData;
        }

        function detectRunTransitions(csvText) {
            const lines = csvText.split('\n').filter(line => line.trim() !== '');
            const transitions = {};
            const adjacencyMap = { "ABR": ["SHS", "WEH"], "ALS": ["LAP", "POP"], "BAN": ["SHA", "BANH"], "BANH": ["BAN"], "BEC": ["GAR"], "BEP": ["CYP", "ROA"], "BLA": ["EAI", "POP"], "BOC": ["DER", "PML"], "CAT": ["EAI", "ROV", "STL", "WST"], "CAW": ["HEQ", "WES", "WIQ"], "CRO": ["MUD", "SOQ"], "CUH": ["PRR", "ROV"], "CUS": ["GRE", "ISG"], "CYP": ["BEP", "GAR"], "DEB": ["ELR", "GRE"], "DER": ["BOC", "LAP"], "EAI": ["BLA", "CAT"], "ELR": ["DEB", "LEW"], "GAR": ["BEC", "CYP"], "GRE": ["CUS", "DEB"], "HEQ": ["CAW", "SOQ"], "ISG": ["CUS", "MUD"], "KGV": ["LCA", "WOA"], "LAP": ["ALS", "DER"], "LCA": ["KGV", "PDK"], "LEW": ["ELR"], "LIM": ["SHA", "WES"], "MUD": ["CRO", "ISG"], "PDK": ["LCA", "WST"], "PML": ["BOC", "STR"], "POP": ["ALS", "BLA", "WES", "WIQ"], "PRR": ["CUH", "ROA"], "ROA": ["BEP", "PRR"], "ROV": ["CAT", "CUH"], "SHA": ["BAN", "LIM", "TOG"], "SHS": ["ABR", "STR"], "SOQ": ["CRO", "HEQ"], "STI": ["STR"], "STL": ["CAT", "WEH"], "STR": ["PML", "SHS", "STI"], "TOG": ["SHA"], "WEH": ["ABR", "STL"], "WES": ["CAW", "LIM", "POP", "WIQ"], "WIQ": ["CAW", "POP", "WES"], "WOA": ["KGV"], "WST": ["CAT", "PDK"] };

            function getStationCode(locationCode) {
                if (locationCode === "BANH") return "BANH";
                if (locationCode === "STR4B") return "STR";
                return locationCode.substring(0, 3);
            }
            function areStationsAdjacent(station1, station2) {
                const code1 = getStationCode(station1);
                const code2 = getStationCode(station2);
                if (code1 === code2) return true;
                if (adjacencyMap[code1] && adjacencyMap[code1].includes(code2)) return true;
                if (adjacencyMap[code2] && adjacencyMap[code2].includes(code1)) return true;
                return false;
            }
            function _parseTime(timeStr) {
                const [hours, minutes, seconds] = timeStr.split(':').map(Number);
                return hours * 3600 + minutes * 60 + (seconds || 0);
            }
            
            const runLineIndices = {};
            lines.forEach((line, index) => {
                const parts = line.split(',');
                if (parts.length >= 7) {
                    const runNumber = parts[1].trim();
                    if (!runLineIndices[runNumber]) runLineIndices[runNumber] = [];
                    runLineIndices[runNumber].push(index);
                }
            });
            const allRuns = Object.keys(runLineIndices);
            for (const fromRun of allRuns) {
                const fromRunIndices = runLineIndices[fromRun];
                if (fromRunIndices.length === 0) continue;
                
                const lastLineIndex = Math.max(...fromRunIndices);
                const lastLine = lines[lastLineIndex];
                const lastLineParts = lastLine.split(',');
                const lastLocationCode = lastLineParts[4].trim();
                const lastDepartureTime = lastLineParts[6].trim();
                const lastDepartureSeconds = _parseTime(lastDepartureTime);
                
                if (lastLocationCode.startsWith('J')) continue;
                
                for (let i = lastLineIndex + 1; i <= lastLineIndex + 3 && i < lines.length; i++) {
                    const nextLine = lines[i];
                    const nextLineParts = nextLine.split(',');
                    if (nextLineParts.length < 7) continue;
                    const nextRun = nextLineParts[1].trim();
                    if (nextRun === fromRun) continue;
                    if (Math.min(...(runLineIndices[nextRun] || [])) !== i) continue;
                    const nextLocationCode = nextLineParts[4].trim();
                    const nextArrivalTime = nextLineParts[5].trim();
                    const nextArrivalSeconds = _parseTime(nextArrivalTime);
                    if (nextLocationCode.startsWith('J')) continue;
                    
                    const timeDiffMinutes = (nextArrivalSeconds - lastDepartureSeconds) / 60;
                    
                    if (areStationsAdjacent(lastLocationCode, nextLocationCode) && timeDiffMinutes >= 0.5 && timeDiffMinutes <= 5) {
                        transitions[fromRun] = { nextRun, location: nextLocationCode, fromLocation: lastLocationCode };
                        break;
                    }
                }
            }
            return transitions;
        }

        function findNextDuty(currentOperatingDate, currentTime, currentDateTime) {
            const lines = dutyData.split('\n');
            let startIndex = -1;
            for (let i = 0; i < lines.length; i++) {
                if (lines[i].trim() === currentOperatingDate + ':') {
                    startIndex = i;
                    break;
                }
            }
            if (startIndex === -1) return null;

            const allDuties = [];
            let dateCount = 0;
            const maxDatesToCheck = 30;

            for (let i = startIndex; i < lines.length && dateCount < maxDatesToCheck; i++) {
                const line = lines[i].trim();
                if (line.endsWith(':')) {
                    dateCount++;
                    const date = line.slice(0, -1);
                    const category = lines[i + 1]?.trim();
                    if (category && !['O', 'AL', 'OAL', 'LD', 'BH'].includes(category)) {
                        let firstHalf = lines[i + 2]?.trim() || '';
                        let secondHalf = lines[i + 3]?.trim() || '';
                        let nextPickupTime = null;
                        let nextPickupLocation = null;

                        if (firstHalf && firstHalf !== 'SPARE') {
                            const info = parseRunInfo(firstHalf);
                            if (info) {
                                nextPickupTime = info.startTime;
                                nextPickupLocation = getLocationName(info.startLocation);
                            }
                        }
                        if (secondHalf && secondHalf !== 'SPARE') {
                            const info = parseRunInfo(secondHalf);
                            if (info && (!nextPickupTime || info.startTime < nextPickupTime)) {
                                nextPickupTime = info.startTime;
                                nextPickupLocation = getLocationName(info.startLocation);
                            }
                        }
                        if (nextPickupTime && nextPickupLocation) {
                            const timeWithSeconds = nextPickupTime.split(':').length === 2 ? nextPickupTime + ':00' : nextPickupTime;
                            const dutyDateTime = new Date(`${date}T${timeWithSeconds}`);
                            if (dutyDateTime > currentDateTime) {
                                allDuties.push({ date, time: nextPickupTime, location: nextPickupLocation, dateTime: dutyDateTime });
                            }
                        }
                    }
                }
            }
            allDuties.sort((a, b) => a.dateTime - b.dateTime);
            return allDuties.length > 0 ? allDuties[0] : null;
        }

        function formatNextDutyDate(nextDuty, currentDateTime) {
            const nextDate = new Date(nextDuty.dateTime);
            const today = new Date(currentDateTime);
            today.setHours(0, 0, 0, 0);
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);
            const nextDateOnly = new Date(nextDate);
            nextDateOnly.setHours(0, 0, 0, 0);
            const timeStr = nextDuty.time.substring(0, 5);

            const getWeekNumber = (d) => {
                d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
                d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
                var yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
                return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
            };

            if (+nextDateOnly === +today) return `today at ${timeStr}`;
            if (+nextDateOnly === +tomorrow) return `tomorrow at ${timeStr}`;
            const dayName = nextDate.toLocaleDateString('en-US', { weekday: 'long' });
            if (getWeekNumber(nextDateOnly) === getWeekNumber(today)) return `on ${dayName} at ${timeStr}`;
            if (getWeekNumber(nextDateOnly) === getWeekNumber(today) + 1) return `on ${dayName} next week at ${timeStr}`;
            
            const day = nextDate.getDate();
            const suffix = (day % 10 === 1 && day !== 11) ? 'st' : (day % 10 === 2 && day !== 12) ? 'nd' : (day % 10 === 3 && day !== 13) ? 'rd' : 'th';
            return `on the ${day}${suffix} of ${nextDate.toLocaleDateString('en-US', { month: 'long' })} at ${timeStr}`;
        }
        
        function calculateCurrentStatus(operatingDate, time, currentDateTime) {
            const lines = dutyData.split('\n');
            let currentDateData = null;
            let foundDate = false;

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                if (line === operatingDate + ':') {
                    foundDate = true;
                    const category = lines[i + 1]?.trim();
                    currentDateData = {
                        category: category,
                        firstHalf: ['O', 'AL', 'OAL', 'LD', 'BH'].includes(category) ? '' : lines[i + 2]?.trim() || '',
                        secondHalf: ['O', 'AL', 'OAL', 'LD', 'BH'].includes(category) ? '' : lines[i + 3]?.trim() || ''
                    };
                    break;
                }
            }

            if (!foundDate) return { main: 'not on the DLR right now', details: 'No duty information found for this date' };

            if (['O', 'AL', 'OAL', 'LD', 'BH'].includes(currentDateData.category)) {
                const nextDuty = findNextDuty(operatingDate, time, currentDateTime);
                return {
                    main: 'not on the DLR right now',
                    details: nextDuty ? `He'll be back at ${nextDuty.location} ${formatNextDutyDate(nextDuty, currentDateTime)}` : 'No upcoming duties found'
                };
            }

            if (currentDateData.firstHalf === 'SPARE' && currentDateData.secondHalf === 'SPARE') {
                return { main: 'somewhere on the DLR', details: 'On a Spare duty' };
            }

            const currentTimeSeconds = parseTime(time);

            const firstHalf = parseRunInfo(currentDateData.firstHalf);
            if (firstHalf) {
                const startDateTime = convertDutyTimeToDateTime(operatingDate, firstHalf.startTime);
                const endDateTime = convertDutyTimeToDateTime(operatingDate, firstHalf.endTime);
                if (currentDateTime >= startDateTime && currentDateTime <= endDateTime) {
                    return getRunStatus(firstHalf, currentTimeSeconds, time);
                }
            }

            const secondHalf = parseRunInfo(currentDateData.secondHalf);
            if (secondHalf) {
                const startDateTime = convertDutyTimeToDateTime(operatingDate, secondHalf.startTime);
                const endDateTime = convertDutyTimeToDateTime(operatingDate, secondHalf.endTime);
                if (currentDateTime >= startDateTime && currentDateTime <= endDateTime) {
                    return getRunStatus(secondHalf, currentTimeSeconds, time);
                }
            }

            if (firstHalf && secondHalf) {
                const firstEndDateTime = convertDutyTimeToDateTime(operatingDate, firstHalf.endTime);
                const secondStartDateTime = convertDutyTimeToDateTime(operatingDate, secondHalf.startTime);
                if (currentDateTime > firstEndDateTime && currentDateTime < secondStartDateTime) {
                    return { main: 'on break', details: `Next service: Run ${secondHalf.runNumber} at ${secondHalf.startTime} at ${getLocationName(secondHalf.startLocation)}` };
                }
            }

            const nextDuty = findNextDuty(operatingDate, time, currentDateTime);
            return {
                main: 'not on the DLR right now',
                details: nextDuty ? `He'll be back at ${nextDuty.location} ${formatNextDutyDate(nextDuty, currentDateTime)}` : 'No upcoming duties found'
            };
        }

        function parseTime(timeStr) {
            const parts = timeStr.split(':');
            return parseInt(parts[0]) * 3600 + parseInt(parts[1]) * 60 + (parts[2] ? parseInt(parts[2]) : 0);
        }

        function getLocationName(locationCode) {
            if (locationCode === 'POD') return 'Poplar depot';
            if (locationCode === 'BED') return 'Beckton depot';
            const stationCode = locationCode.substring(0, 3);
            return locationMapping[stationCode] || locationCode;
        }

        function getDepotName(locationCode) {
            if (locationCode === 'POD') return 'Poplar depot';
            if (locationCode === 'BED') return 'Beckton depot';
            return locationCode;
        }

        function detectTrips(stops) {
            const trips = [];
            let currentTrip = [];
            let tripNumber = 1;
            for (let i = 0; i < stops.length; i++) {
                currentTrip.push(stops[i]);
                if (i < stops.length - 2 && stops[i].location === stops[i + 2].location && stops[i].location !== stops[i + 1].location) {
                    trips.push({ tripNumber, from: currentTrip[0].location, to: stops[i + 1].location, stops: [...currentTrip, stops[i + 1]] });
                    currentTrip = [stops[i + 1]];
                    tripNumber++;
                    i++;
                }
            }
            if (currentTrip.length > 0) trips.push({ tripNumber, from: currentTrip[0].location, to: currentTrip[currentTrip.length - 1].location, stops: [...currentTrip] });
            return trips;
        }

        function getCurrentTripDestination(runNumber, currentTimeSeconds) {
            if (!parsedCsvData[runNumber] || parsedCsvData[runNumber].length === 0) return null;
            const trips = detectTrips(parsedCsvData[runNumber]);
            for (let i = 0; i < trips.length; i++) {
                const trip = trips[i];
                const tripStartTime = parseTime(trip.stops[0].departureTime);
                const tripEndTime = parseTime(trip.stops[trip.stops.length - 1].arrivalTime);
                if (currentTimeSeconds >= tripStartTime && currentTimeSeconds <= tripEndTime) {
                    if (currentTimeSeconds >= tripEndTime && i < trips.length - 1) {
                        const nextTrip = trips[i + 1];
                        if (currentTimeSeconds < parseTime(nextTrip.stops[0].departureTime) && trip.to === nextTrip.from) return nextTrip.to;
                    }
                    return trip.to;
                }
            }
            return parsedCsvData[runNumber][parsedCsvData[runNumber].length - 1].location;
        }

        function getRunFirstStation(runNumber) {
            if (!parsedCsvData[runNumber] || parsedCsvData[runNumber].length === 0) return null;
            const firstStop = parsedCsvData[runNumber][0];
            return { location: firstStop.location, time: firstStop.arrivalTime };
        }

        function getRunLastStation(runNumber) {
            if (!parsedCsvData[runNumber] || parsedCsvData[runNumber].length === 0) return null;
            const lastStop = parsedCsvData[runNumber][parsedCsvData[runNumber].length - 1];
            return { location: lastStop.location, time: lastStop.departureTime };
        }

        function parseRunInfo(runString) {
            const parts = runString.split(' ');
            if (parts.length < 5) return null;
            const runPart = parts[0].substring(1);
            let firstRun = runPart, secondRun = null, transitionTime = null;
            if (runPart.includes('>')) {
                [firstRun, secondRun] = runPart.split('>');
                if (parsedCsvData[firstRun]) {
                    const lastStop = parsedCsvData[firstRun].slice(-1)[0];
                    transitionTime = parseTime(lastStop.departureTime);
                }
            }
            return { runNumber: runPart, firstRun, secondRun, transitionTime, startLocation: parts[1], startTime: parts[2], endTime: parts[3], endLocation: parts[4] };
        }

        function getRunStatus(runInfo, currentTimeSeconds, timeStr) {
            if (currentTimeSeconds < parseTime(runInfo.startTime) + 60) {
                let runNumber = runInfo.secondRun && currentTimeSeconds > runInfo.transitionTime ? runInfo.secondRun : runInfo.firstRun;
                let destination = parsedCsvData[runNumber] ? parsedCsvData[runNumber].slice(-1)[0].location : getLocationName(runInfo.endLocation);
                return { main: `departing ${getLocationName(runInfo.startLocation)}`, details: `onboard Run ${runInfo.runNumber} to ${destination}` };
            }

            let actualRunNumber = runInfo.firstRun;
            if (runInfo.secondRun && runInfo.transitionTime && currentTimeSeconds > runInfo.transitionTime) {
                const secondRunStops = parsedCsvData[runInfo.secondRun];
                if (secondRunStops && secondRunStops.length > 0) {
                    if (currentTimeSeconds < parseTime(secondRunStops[0].arrivalTime)) {
                        const firstRunLastStop = parsedCsvData[runInfo.firstRun].slice(-1)[0];
                        return { main: `between ${firstRunLastStop.location} and ${secondRunStops[0].location}`, details: `Transitioning from Run ${runInfo.firstRun} to Run ${runInfo.secondRun}` };
                    }
                    actualRunNumber = runInfo.secondRun;
                }
            }

            if (['POD', 'BED'].includes(runInfo.startLocation.substring(0,3)) || ['POD', 'BED'].includes(runInfo.endLocation.substring(0,3))) {
                // Depot logic... (unchanged)
                return { main: 'somewhere on the DLR', details: `on an empty stock movement related to Run ${actualRunNumber}`};
            }

            if (!parsedCsvData[actualRunNumber]) {
                return { main: `operating between ${getLocationName(runInfo.startLocation)} and ${getLocationName(runInfo.endLocation)}`, details: `onboard Run ${actualRunNumber} - timetable not available` };
            }

            const destination = getCurrentTripDestination(actualRunNumber, currentTimeSeconds);
            const currentPosition = findCurrentPosition(parsedCsvData[actualRunNumber], timeStr, currentTimeSeconds);

            switch (currentPosition.type) {
                case 'at_station':
                    return { main: `at ${currentPosition.location}`, details: `onboard Run ${actualRunNumber} to ${destination} - ${currentPosition.details}` };
                case 'departing_station':
                    return { main: `departing ${currentPosition.location}`, details: `onboard Run ${actualRunNumber} to ${destination}` };
                case 'approaching_station':
                    return { main: `approaching ${currentPosition.to}`, details: `onboard Run ${actualRunNumber} to ${destination}` };
                case 'between_stations':
                    return { main: `between ${currentPosition.from} and ${currentPosition.to}`, details: `onboard Run ${actualRunNumber} to ${destination}` };
                default:
                    return { main: 'somewhere on the DLR', details: `onboard Run ${actualRunNumber} to ${destination}` };
            }
        }

        function findCurrentPosition(runStops, currentTime, currentTimeSeconds) {
            for (let i = 0; i < runStops.length; i++) {
                const stop = runStops[i];
                const arrival = parseTime(stop.arrivalTime);
                const departure = parseTime(stop.departureTime);

                if (currentTimeSeconds >= departure - 10 && currentTimeSeconds <= departure + 10) return { type: 'departing_station', location: stop.location };
                if (currentTimeSeconds >= arrival && currentTimeSeconds < departure - 10) {
                    const diff = departure - currentTimeSeconds;
                    const details = diff > 60 ? `departing in ${Math.floor(diff / 60)} minute${Math.floor(diff / 60) > 1 ? 's' : ''}` : 'departing soon';
                    return { type: 'at_station', location: stop.location, details };
                }
                if (i < runStops.length - 1) {
                    const nextStop = runStops[i + 1];
                    const nextArrival = parseTime(nextStop.arrivalTime);
                    if (currentTimeSeconds >= nextArrival - 20 && currentTimeSeconds < nextArrival) return { type: 'approaching_station', from: stop.location, to: nextStop.location };
                    if (currentTimeSeconds > departure + 10 && currentTimeSeconds < nextArrival - 20) return { type: 'between_stations', from: stop.location, to: nextStop.location };
                }
            }
            return { type: 'unknown' };
        }

        function displayStatus(main, details, animate = false) {
            if (updateBuffer.timer) clearTimeout(updateBuffer.timer);
            updateBuffer.pendingUpdate = { main, details, animate };
            updateBuffer.timer = setTimeout(() => {
                const update = updateBuffer.pendingUpdate;
                if (!update) return;
                
                updateParticleSpeed({ main: update.main, details: update.details });
                
                const statusMain = document.getElementById('statusMain');
                const statusDetails = document.getElementById('statusDetails');
                const loadingState = document.getElementById('loadingState');
                if (!statusMain || !statusDetails) return;

                console.log(`[${new Date().toLocaleTimeString()}] Status updated: "${update.main}" | "${update.details}"`);
                
                if (loadingState) loadingState.style.display = 'none';
                
                if (!update.animate) {
                    statusMain.textContent = update.main;
                    statusDetails.textContent = update.details;
                    return;
                }
                
                statusMain.style.animation = 'none';
                statusDetails.style.animation = 'none';
                
                statusMain.style.opacity = '0';
                statusMain.style.transform = 'translateY(10px)';
                statusMain.style.transition = 'opacity 0.4s ease-out, transform 0.4s ease-out';
                
                setTimeout(() => {
                    statusMain.textContent = update.main;
                    statusMain.style.opacity = '1';
                    statusMain.style.transform = 'translateY(0)';
                    statusMain.style.transition = 'opacity 0.6s ease-out, transform 0.6s ease-out';
                    setTimeout(() => { statusMain.style.transition = ''; }, 600);
                }, 400);
                
                setTimeout(() => {
                    statusDetails.classList.add('details-fade-out');
                    setTimeout(() => {
                        statusDetails.textContent = update.details;
                        statusDetails.classList.remove('details-fade-out');
                        statusDetails.classList.add('details-fade-in');
                        setTimeout(() => statusDetails.classList.remove('details-fade-in'), 400);
                    }, 300);
                }, 700);
                
                updateBuffer.pendingUpdate = null;
                updateBuffer.timer = null;
            }, 3000);
        }
        
        // Initialize particles
        createParticles();

    </script>

    <!-- Firebase SDK Loader -->
    <script>
		function loadFirebase() {
			const loadScript = (src, callback) => {
				const script = document.createElement('script');
				script.src = src;
				script.onload = callback;
				document.body.appendChild(script);
			};
			
			loadScript('https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js', () => {
				loadScript('https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js', () => {
					loadScript('https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js', () => {
						const firebaseConfig = {
							apiKey: "AIzaSyBkKclvdWHVQ58IFG_ap0ByJA_2a8J2YXU",
							authDomain: "owngoal-4f34f.firebaseapp.com",
							projectId: "owngoal-4f34f",
							storageBucket: "owngoal-4f34f.firebasestorage.app", // FIXED: Changed from .appspot.com
							messagingSenderId: "270078133518",
							appId: "1:270078133518:web:36ef7431fda632bed1c35f"
						};
						firebase.initializeApp(firebaseConfig);
						
						// ADD: Set persistence like the working app
						firebase.auth().setPersistence(firebase.auth.Auth.Persistence.LOCAL)
							.catch(error => {
								console.error("Persistence error:", error);
							});
						
						// ADD THIS: Authentication state handler
						firebase.auth().onAuthStateChanged((user) => {
							if (user) {
								console.log('User is signed in:', user.email);
								initializeApp();
							} else {
								console.log('User is signed out.');
								loginSplashScreen.style.display = 'flex';
								loginSplashScreen.style.opacity = '1';
								mainContainer.style.display = 'none';
								loginButton.disabled = false;
								loginStatus.style.display = 'none';
							}
						});
						
					});
				});
			});
		}
		loadFirebase();
    </script>
</body>
</html>