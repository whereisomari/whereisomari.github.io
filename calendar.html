<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Duty Calendar - Where is Omari?</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background: #0a0a0a;
            color: #ffffff;
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
        }
        
        /* Enhanced particle system */
        .particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }

        .particle {
            position: absolute;
            border-radius: 50%;
            pointer-events: none;
        }

        .particle-small {
            width: 1px;
            height: 1px;
            background: rgba(255, 255, 255, 0.9);
            box-shadow: 0 0 2px rgba(255, 255, 255, 0.8);
            animation: floatUp 4s infinite linear;
        }

        .particle-medium {
            width: 2px;
            height: 2px;
            background: rgba(100, 200, 255, 0.95);
            box-shadow: 0 0 4px rgba(100, 200, 255, 0.7);
            animation: floatUp 6s infinite linear;
        }

        .particle-large {
            width: 3px;
            height: 3px;
            background: rgba(255, 100, 200, 0.9);
            box-shadow: 0 0 6px rgba(255, 100, 200, 0.6);
            animation: floatUp 8s infinite linear;
        }

        @keyframes floatUp {
            0% {
                transform: translateY(120vh) rotate(0deg);
                opacity: 0;
            }
            3% {
                opacity: 0;
            }
            8% {
                opacity: 1;
            }
            92% {
                opacity: 1;
            }
            97% {
                opacity: 0;
            }
            100% {
                transform: translateY(-20vh) rotate(360deg);
                opacity: 0;
            }
        }

        /* Particle mask to hide stuck particles at top */
        .particle-mask {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: #0a0a0a;
            z-index: 2;
        }

        /* Login Screen Styles */
        .login-splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(10, 10, 10, 0.7);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: opacity 0.5s ease;
        }

        .login-content {
            background: rgba(20, 20, 20, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 40px;
            border-radius: 15px;
            text-align: center;
            width: 90%;
            max-width: 380px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .login-input {
            width: 100%;
            padding: 12px 15px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: white;
            font-size: 1rem;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }

        .login-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 15px rgba(102, 126, 234, 0.4);
        }

        .login-button {
            width: 100%;
            padding: 12px 15px;
            background: linear-gradient(90deg, #8A2BE2, #4B0082);
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .login-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(138, 43, 226, 0.4);
        }

        .login-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .login-error {
            margin-top: 20px;
            font-size: 0.9rem;
            min-height: 1.2em;
            color: #ff6b6b;
        }

        /* Text overlay to hide content during loading */
        .text-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #0a0a0a;
            z-index: 40;
            transition: opacity 0.8s ease-out;
        }
        
        /* Loading overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
            transition: opacity 0.8s ease-out;
        }
        
        .simple-loader {
            width: 60px;
            height: 60px;
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            border-top: 3px solid;
            border-top-color: hsl(300, 80%, 70%);
            animation: spin 1.5s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Main container */
        .container {
            position: relative;
            z-index: 10;
            min-height: 100vh;
            display: none;
            flex-direction: column;
            padding: 2rem;
            max-width: 1200px;
            margin: 0 auto;
        }

        /* Header */
        .header {
            text-align: center;
            margin-bottom: 3rem;
            position: relative;
        }

        .nav-link {
            position: absolute;
            top: 0;
            left: 0;
            color: #667eea;
            text-decoration: none;
            padding: 8px 16px;
            border: 1px solid rgba(102, 126, 234, 0.3);
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .nav-link:hover {
            background: rgba(102, 126, 234, 0.1);
            border-color: #667eea;
        }

        .page-title {
            font-size: clamp(2rem, 6vw, 3.5rem);
            font-weight: 300;
            margin-bottom: 1rem;
            line-height: 1.2;
        }

        .title-gradient {
            background: linear-gradient(to right, hsl(300, 80%, 70%), hsl(270, 80%, 61%), hsl(235, 85%, 55%), hsl(300, 80%, 70%));
            background-size: 300% 300%;
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: gradientCycle 5s linear infinite;
        }

        .title-white {
            color: #ffffff;
        }

        @keyframes gradientCycle {
            0% { background-position: 150% 0%, 0% 50%; }
            33% { background-position: 100% 100%, 50% 50%; }
            66% { background-position: 50% 50%, 100% 0%; }
            100% { background-position: 0% 0%, 150% 50%; }
        }

        /* Calendar grid */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .duty-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .duty-card:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        .duty-card.rest-day {
            cursor: default;
        }

        .duty-card.rest-day:hover {
            transform: none;
        }

        .duty-date {
            font-size: 0.9rem;
            color: #888;
            margin-bottom: 0.5rem;
        }

        .duty-main {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #ffffff;
        }

        .duty-details {
            font-size: 0.9rem;
            color: #ccc;
            margin-bottom: 1rem;
        }

        .duty-times {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            color: #888;
        }

        .duty-category {
            position: absolute;
            top: 12px;
            right: 12px;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 600;
        }

        /* Category colors */
        .category-AL { background: #22330B; }
        .category-BH { background: #2B1710; }
        .category-E { background: #004659; }
        .category-EE { background: #004659; }
        .category-EM { background: #003939; }
        .category-IT { background: #80215D; }
        .category-L { background: #002039; }
        .category-LD { background: #5E2405; }
        .category-LL { background: #002039; }
        .category-M { background: #003939; }
        .category-ML { background: #003939; }
        .category-MRD { background: #063004; }
        .category-O { background: #063004; }
        .category-OAL { background: #22330B; }
        .category-OT { background: #6E0811; }
        .category-RD { background: #063004; }
        .category-Swap { background: #3A2F00; }
        .category-T { background: #80215D; }

        /* Duty detail modal */
        .duty-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(8px);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }
        
        .duty-modal-content {
            background: #1a1a1a;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            max-width: 600px;
            width: 100%;
            max-height: 80vh;
            overflow: hidden; /* Important for slide animation */
            position: relative;
            min-width: 0;
        }

        /* Modal open/close animations */
        .modal-opening .duty-modal-content {
            animation: zoomIn 0.4s cubic-bezier(0.165, 0.84, 0.44, 1) forwards;
        }
        .modal-closing .duty-modal-content {
            /* FASTER aNIMATION */
            animation: zoomOut 0.2s cubic-bezier(0.55, 0.055, 0.675, 0.19) forwards;
        }

        @keyframes zoomIn {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
        @keyframes zoomOut {
            from {
                opacity: 1;
                transform: scale(1);
            }
            to {
                opacity: 0;
                transform: scale(0.95);
            }
        }
        
        /* NEW Card-switching slide animations */
        .duty-modal-body {
            height: calc(80vh - 65px);
            overflow: hidden;
        }

        .slide-container {
            position: relative;
            width: 100%;
            height: 100%;
        }

        .slide-pane {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94), opacity 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            overflow-y: auto;
            padding: 1.5rem;
        }

        .slide-pane.timetable {
            padding: 0;
        }

        /* A pane that is 'in' the viewport and visible */
        .slide-pane.is-center {
            transform: translateX(0);
            opacity: 1;
        }

        /* A pane that is to the left of the viewport and hidden */
        .slide-pane.is-left {
            transform: translateX(-100%);
            opacity: 0;
        }

        /* A pane that is to the right of the viewport and hidden */
        .slide-pane.is-right {
            transform: translateX(100%);
            opacity: 0;
        }


        .duty-modal-header {
            background: linear-gradient(90deg, #8A2BE2, #4B0082);
            color: white;
            padding: 0.8rem 1.2rem;
            font-size: 1.2rem;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            z-index: 20;
            border-radius: 15px 15px 0 0;
            min-height: 65px;
            box-sizing: border-box;
        }

        .close-modal {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: background-color 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 40px;
            min-height: 40px;
        }

        .close-modal:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .section {
            margin-bottom: 1.5rem;
        }

        .section-header {
            font-size: 1rem;
            color: #667eea;
            margin-bottom: 0.5rem;
            padding-bottom: 0.25rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .section-item {
            margin-bottom: 0.5rem;
            display: flex;
            gap: 1rem;
        }

        .section-label {
            color: #888;
            min-width: 80px;
        }

        .error-message {
            text-align: center;
            color: #ff6b6b;
            font-size: 1.1rem;
            margin-top: 2rem;
        }
        
        .timetable-sticky-header {
            position: sticky;
            top: 0;
            z-index: 15;
            background: #1a1a1a;
        }
        .timetable-sticky-header th {
             border: none;
        }

        /* Responsive design */
        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }
            
            .calendar-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            .duty-modal {
                padding: 1rem;
            }

            .header {
                margin-bottom: 2rem;
            }

            .nav-link {
                position: static;
                display: block;
                margin: 0 auto 1rem auto;
                width: fit-content;
            }

            .page-title {
                font-size: clamp(2.5rem, 8vw, 4rem);
                margin-bottom: 0.5rem;
            }
            
            .duty-modal-content {
                margin: 0 auto;
                max-width: calc(100vw - 2rem);
            }
            
            .duty-modal-header {
                padding: 0.5rem 1rem;
                font-size: 1.1rem;
                min-height: 50px;
            }
            .duty-modal-body {
                height: calc(80vh - 50px);
            }
            
            .close-modal {
                min-height: 40px;
                padding: 4px 8px;
            }
            
            .timetable-sticky-header {
                top: 0;
            }
            
            .slide-pane {
                 padding: 1rem;
            }
            
            .slide-pane.timetable {
                padding: 0;
            }

            .duty-modal-content table {
                font-size: 12px;
            }
            
            .duty-modal-content td {
                padding: 8px 6px !important;
                height: 48px !important;
                vertical-align: middle !important;
            }
        }
    </style>
</head>
<body>
    <!-- Enhanced particle background -->
    <div class="particles" id="particles"></div>
    
    <!-- Particle mask to hide stuck particles at top -->
    <div class="particle-mask"></div>
    
    <!-- Login Screen -->
    <div class="login-splash-screen" id="loginSplashScreen">
        <div class="login-content">
            <div id="loginForm">
                <input type="password" id="passwordInput" class="login-input" placeholder="Password">
                <button id="loginButton" class="login-button" onclick="signIn()">Sign In</button>
                <div id="loginError" class="login-error"></div>
            </div>
        </div>
    </div>
    
    <!-- Text overlay to hide content during loading -->
    <div class="text-overlay" id="textOverlay"></div>
    
    <!-- Loading overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="simple-loader"></div>
    </div>

    <!-- Main content -->
    <div class="container" id="mainContainer">
        <div class="header">
            <a href="/" class="nav-link">View Realtime</a>
            <h1 class="page-title">
                <span class="title-gradient">Omari's</span><br>
                <span class="title-white">Duty Calendar</span>
            </h1>
        </div>
        
        <div class="calendar-grid" id="calendarGrid">
            <!-- Calendar items will be populated here -->
        </div>
        
        <div id="errorMessage" class="error-message" style="display: none;"></div>
    </div>

    <!-- Duty Detail Modal -->
    <div class="duty-modal" id="dutyModal">
        <div class="duty-modal-content">
            <div class="duty-modal-header">
                <span id="modalTitle">Duty Details</span>
                <button class="close-modal" onclick="closeDutyModal()">&times;</button>
            </div>
            <div class="duty-modal-body" id="modalBody">
                <!-- Slide panes will be populated here -->
            </div>
        </div>
    </div>

    <script>
        // Data storage
        let dutyTrackerData = null;
        let dutyLookupData = {
            base: {},
            singleTemp: {},
            rangeTemp: []
        };

        // Authentication variables
        const mainContainer = document.getElementById('mainContainer');
        const loginSplashScreen = document.getElementById('loginSplashScreen');
        const loginError = document.getElementById('loginError');
        const loginButton = document.getElementById('loginButton');
        const passwordInput = document.getElementById('passwordInput');

        // Enhanced particle system
        function createParticles() {
            const particlesContainer = document.getElementById('particles');
            const particleCount = 300;
            
            for (let i = 0; i < particleCount; i++) {
                const particle = document.createElement('div');
                
                const types = ['particle-small', 'particle-medium', 'particle-large'];
                const typeWeights = [0.6, 0.3, 0.1];
                
                let randomType = 'particle-small';
                const rand = Math.random();
                if (rand > typeWeights[0] + typeWeights[1]) {
                    randomType = 'particle-large';
                } else if (rand > typeWeights[0]) {
                    randomType = 'particle-medium';
                }
                
                particle.className = `particle ${randomType}`;
                particle.style.left = Math.random() * 100 + '%';
                
                const initialDelay = Math.random() * 20 + 's';
                particle.style.animationDelay = initialDelay;
                
                const baseDuration = Math.random() * 4 + 4;
                particle.style.animationDuration = baseDuration + 's';
                particle.dataset.baseDuration = baseDuration;
                
                particlesContainer.appendChild(particle);
                
                setTimeout(() => {
                    const animations = particle.getAnimations();
                    if (animations.length > 0) {
                        animations[0].playbackRate = 0.05;
                        particle.dataset.currentRate = 0.05;
                    }
                }, 100);
            }
        }

        // Authentication functions
        function signIn() {
            const email = 'standard@yourapp.local';
            const password = passwordInput.value;
            
            if (!password) {
                loginError.textContent = "Please enter your password.";
                return;
            }

            loginButton.disabled = true;
            loginError.textContent = '';

            firebase.auth().signInWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    console.log('Sign in successful');
                })
                .catch((error) => {
                    console.error('Sign in error:', error);
                    loginError.textContent = getUserFriendlyAuthError(error);
                    loginButton.disabled = false;
                });
        }
        
        passwordInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                signIn();
            }
        });

        function getUserFriendlyAuthError(error) {
            switch (error.code) {
                case 'auth/invalid-login-credentials':
                case 'auth/user-not-found':
                case 'auth/wrong-password':
                case 'auth/invalid-email':
                    return "Incorrect password. Please try again.";
                case 'auth/too-many-requests':
                    return "Access temporarily disabled. Please try again later.";
                case 'auth/network-request-failed':
                    return "Network error. Please check your connection.";
                default:
                    return "Login error: " + error.message;
            }
        }

        // Initialize app after login
        function initializeApp() {
            console.log('Initializing calendar app');
            
            loginSplashScreen.style.opacity = '0';
            setTimeout(() => {
                loginSplashScreen.style.display = 'none';
            }, 500);

            mainContainer.style.display = 'flex';
            
            // Load duty tracker, duty lookup data, and timetable paths
            Promise.all([
                fetchDutyTracker(),
                fetchDutyLookupData(),
                initializeTimetablePaths()
            ])
            .then(() => {
                console.log('All data loaded successfully');
                populateCalendar();
                
                // Fade out overlays
                setTimeout(() => {
                    const loadingOverlay = document.getElementById('loadingOverlay');
                    if (loadingOverlay) {
                        loadingOverlay.style.opacity = '0';
                        setTimeout(() => {
                            loadingOverlay.style.display = 'none';
                        }, 800);
                    }
                }, 3200);
                
                setTimeout(() => {
                    const textOverlay = document.getElementById('textOverlay');
                    if (textOverlay) {
                        textOverlay.style.opacity = '0';
                        setTimeout(() => {
                            textOverlay.style.display = 'none';
                        }, 800);
                    }
                }, 4000);
            })
            .catch(error => {
                console.error("Data loading failed:", error);
                showError('Error loading duty data: ' + error.message);
                
                // Hide overlays even on error
                setTimeout(() => {
                    const loadingOverlay = document.getElementById('loadingOverlay');
                    const textOverlay = document.getElementById('textOverlay');
                    if (loadingOverlay) loadingOverlay.style.display = 'none';
                    if (textOverlay) textOverlay.style.display = 'none';
                }, 2000);
            });
        }

        // Fetch duty tracker data
        function fetchDutyTracker() {
            return new Promise((resolve, reject) => {
                const storageRef = firebase.storage().ref('tracker');
                
                storageRef.listAll()
                    .then((result) => {
                        const trackerFile = result.items.find(item => item.name === 'duty-tracker.txt');
                        if (!trackerFile) {
                            throw new Error('duty-tracker.txt not found');
                        }
                        
                        return trackerFile.getDownloadURL();
                    })
                    .then((url) => {
                        return fetch(url);
                    })
                    .then(response => {
                        if (!response.ok) throw new Error(`HTTP ${response.status}`);
                        return response.text();
                    })
                    .then(text => {
                        dutyTrackerData = text;
                        resolve();
                    })
                    .catch(error => {
                        console.error('Error fetching duty tracker:', error);
                        reject(error);
                    });
            });
        }

        // Fetch duty lookup data
        function fetchDutyLookupData() {
            return new Promise((resolve, reject) => {
                const storageRef = firebase.storage().ref('duty-files');
                
                storageRef.listAll()
                    .then((result) => {
                        const promises = result.items.map(fileRef => {
                            return fileRef.getDownloadURL()
                                .then(url => fetch(url))
                                .then(response => response.text())
                                .then(content => {
                                    const jsonMatch = content.match(/var\s+ExtractedDuties\s*=\s*(\{.*\});/s);
                                    if (jsonMatch) {
                                        const duties = JSON.parse(jsonMatch[1]);
                                        processDutyFile(fileRef.name, duties);
                                    }
                                });
                        });
                        
                        return Promise.all(promises);
                    })
                    .then(() => {
                        console.log('Duty lookup data loaded');
                        resolve();
                    })
                    .catch(error => {
                        console.error('Error fetching duty lookup data:', error);
                        reject(error);
                    });
            });
        }

        // Process duty file (from dlrduties.html)
        function processDutyFile(filename, duties) {
            const parts = filename.split('.')[0].split('-');
            
            if (filename.includes('-to-')) {
                const [startYear, startMonth, startDay, , endYear, endMonth, endDay] = parts;
                const startDate = new Date(startYear, startMonth - 1, startDay);
                const endDate = new Date(endYear, endMonth - 1, endDay);
                dutyLookupData.rangeTemp.push({
                    startDate,
                    endDate,
                    duties,
                    filename
                });
            } else if (filename.endsWith('-Base.json')) {
                const [year, month, day] = parts;
                const baseDate = new Date(year, month - 1, day);
                dutyLookupData.base[baseDate.getTime()] = {
                    duties,
                    filename
                };
            } else if (filename.endsWith('-Temp.json')) {
                const [year, month, day] = parts;
                const dateKey = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
                dutyLookupData.singleTemp[dateKey] = {
                    duties,
                    filename
                };
            }
        }

        // Get current time in timezone
        function getCurrentTimeInTimezone() {
            const now = new Date();
            try {
                const localTimeString = now.toLocaleString("en-US", {
                    timeZone: "Europe/London",
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: false
                });
                
                const [datePart, timePart] = localTimeString.split(', ');
                const [month, day, year] = datePart.split('/');
                const [hour, minute, second] = timePart.split(':');
                
                return new Date(year, month - 1, day, hour, minute, second);
            } catch (error) {
                console.error('getCurrentTimeInTimezone failed:', error);
                return new Date();
            }
        }

        // Get operating date
        function getOperatingDate(dateTime = null) {
            const localDateTime = getCurrentTimeInTimezone(dateTime || new Date());
            if (localDateTime.getHours() < 3) {
                localDateTime.setDate(localDateTime.getDate() - 1);
            }
            return localDateTime.toISOString().split('T')[0];
        }

        // Parse duty tracker to get next 21 days
        function parseNext21Days() {
            if (!dutyTrackerData) return [];
            
            const lines = dutyTrackerData.split('\n');
            const duties = [];
            const startDate = getOperatingDate();
            
            let dateCount = 0;
            let i = 0;
            
            // Find starting date
            while (i < lines.length && dateCount < 21) {
                const line = lines[i].trim();
                if (line.endsWith(':')) {
                    const date = line.slice(0, -1);
                    
                    if (date >= startDate) {
                        const category = lines[i + 1]?.trim();
                        const dutyNumber = lines[i + 2]?.trim();
                        
                        let firstHalf = '';
                        let secondHalf = '';
                        
                        if (category && !['O', 'AL', 'OAL', 'LD', 'BH', 'RD', 'MRD'].includes(category)) {
                            firstHalf = lines[i + 3]?.trim() || '';
                            secondHalf = lines[i + 4]?.trim() || '';
                        }
                        
                        duties.push({
                            date,
                            category,
                            dutyNumber,
                            firstHalf,
                            secondHalf
                        });
                        
                        dateCount++;
                    }
                }
                i++;
            }
            
            return duties;
        }

        // Get duty info for lookup
        function getDutyForDate(dutyNumber, dateStr) {
            const versions = [];
            const [year, month, day] = dateStr.split('-');
            const date = new Date(year, month - 1, day);

            // Check single day temp
            const dateKey = `${year}-${month}-${day}`;
            if (dutyLookupData.singleTemp[dateKey]) {
                const tempDuty = Object.entries(dutyLookupData.singleTemp[dateKey].duties)
                    .find(([key]) => key.startsWith(dutyNumber + '-'));
                if (tempDuty) {
                    versions.push({
                        type: 'temp',
                        date: dateStr,
                        duty: tempDuty[1],
                        dutyId: tempDuty[0],
                        filename: dutyLookupData.singleTemp[dateKey].filename
                    });
                }
            }

            // Check range temp
            const rangeTempMatch = dutyLookupData.rangeTemp.find(range => 
                date >= range.startDate && date <= range.endDate);
            if (rangeTempMatch) {
                const tempDuty = Object.entries(rangeTempMatch.duties)
                    .find(([key]) => key.startsWith(dutyNumber + '-'));
                if (tempDuty) {
                    versions.push({
                        type: 'temp',
                        dateRange: {
                            start: rangeTempMatch.startDate.toISOString().split('T')[0],
                            end: rangeTempMatch.endDate.toISOString().split('T')[0]
                        },
                        duty: tempDuty[1],
                        dutyId: tempDuty[0],
                        filename: rangeTempMatch.filename
                    });
                }
            }

            // Check base duties
            const baseDate = Object.keys(dutyLookupData.base)
                .map(Number)
                .filter(time => new Date(time) <= date)
                .sort((a, b) => b - a)[0];

            if (baseDate) {
                const baseDutyId = Object.keys(dutyLookupData.base[baseDate].duties)
                    .find(key => key.startsWith(dutyNumber + '-'));
                if (baseDutyId) {
                    versions.push({
                        type: 'base',
                        date: new Date(baseDate).toISOString().split('T')[0],
                        duty: dutyLookupData.base[baseDate].duties[baseDutyId],
                        dutyId: baseDutyId,
                        filename: dutyLookupData.base[baseDate].filename
                    });
                }
            }

            return versions;
        }

        // Populate calendar
        function populateCalendar() {
            const duties = parseNext21Days();
            const grid = document.getElementById('calendarGrid');
            
            if (duties.length === 0) {
                showError('No duty data found');
                return;
            }
            
            grid.innerHTML = '';
            
            duties.forEach(dutyInfo => {
                const card = createDutyCard(dutyInfo);
                grid.appendChild(card);
            });
        }

        // Create duty card
        function createDutyCard(dutyInfo) {
            const card = document.createElement('div');
            card.className = 'duty-card';
            
            const date = new Date(dutyInfo.date);
            const dateStr = date.toLocaleDateString('en-GB', { 
                weekday: 'long', 
                day: 'numeric', 
                month: 'long', 
                year: 'numeric' 
            });
            
            const dayNames = {
                "O": "Rest day",
                "AL": "Annual leave",
                "OAL": "Owed annual leave",
                "LD": "Lieu day",
                "BH": "Bank holiday",
                "RD": "Rest day",
                "MRD": "Rest day",
                "IT": "Training",
                "T": "Training",
                "Swap": "Swap duty"
            };
            
            // Check if this is a non-working day
            const nonWorkingCategories = ['O', 'AL', 'OAL', 'LD', 'BH', 'RD', 'MRD'];
            if (nonWorkingCategories.includes(dutyInfo.category)) {
                card.classList.add('rest-day');
                
                // Set the card background to the category color with transparency
                const categoryColors = {
                    "AL": "rgba(34, 51, 11, 0.7)",
                    "BH": "rgba(43, 23, 16, 0.7)", 
                    "E": "rgba(0, 70, 89, 0.7)",
                    "EE": "rgba(0, 70, 89, 0.7)",
                    "EM": "rgba(0, 57, 57, 0.7)",
                    "IT": "rgba(128, 33, 93, 0.7)",
                    "L": "rgba(0, 32, 57, 0.7)",
                    "LD": "rgba(94, 36, 5, 0.7)",
                    "LL": "rgba(0, 32, 57, 0.7)",
                    "M": "rgba(0, 57, 57, 0.7)",
                    "ML": "rgba(0, 57, 57, 0.7)",
                    "MRD": "rgba(6, 48, 4, 0.7)",
                    "O": "rgba(6, 48, 4, 0.7)",
                    "OAL": "rgba(34, 51, 11, 0.7)",
                    "OT": "rgba(110, 8, 17, 0.7)",
                    "RD": "rgba(6, 48, 4, 0.7)",
                    "Swap": "rgba(58, 47, 0, 0.7)",
                    "T": "rgba(128, 33, 93, 0.7)"
                };
                
                card.style.background = categoryColors[dutyInfo.category] || 'rgba(51, 51, 51, 0.7)';
                
                card.innerHTML = `
                    <div class="duty-date">${dateStr}</div>
                    <div class="duty-main">${dayNames[dutyInfo.category] || dutyInfo.category}</div>
                    <div class="duty-category category-${dutyInfo.category}">${dutyInfo.category}</div>
                `;
                return card;
            }
            
            // Working duty
            let dutyMain = '';
            let dutyDetails = '';
            let dutyTimes = '';
            
            if (dutyInfo.dutyNumber) {
                // Try to get duty details from lookup data
                const versions = getDutyForDate(dutyInfo.dutyNumber, dutyInfo.date);
                if (versions.length > 0) {
                    const dutyId = versions[0].dutyId;
                    const parts = dutyId.split('-');
                    const location = parts[1];
                    const startTime = parts[3];
                    const endTime = parts[4];
                    
                    dutyMain = `Duty ${dutyInfo.dutyNumber}`;
                    dutyDetails = `${location} ${startTime}-${endTime}`;
                    dutyTimes = `<span>Book on: ${startTime}</span><span>Book off: ${endTime}</span>`;
                    
                    card.addEventListener('click', () => {
                        const dutyDateParts = dutyInfo.date.split('-');
                        currentDutyDate = new Date(dutyDateParts[0], dutyDateParts[1] - 1, dutyDateParts[2]);
                        
                        currentTimetableData = null;
                        showDutyDetails(versions[0], dutyInfo.dutyNumber);
                    });
                } else {
                    dutyMain = `Duty ${dutyInfo.dutyNumber}`;
                    dutyDetails = 'Details not available';
                }
            } else {
                dutyMain = dutyInfo.category;
                dutyDetails = 'Working duty';
            }
            
            card.innerHTML = `
                <div class="duty-date">${dateStr}</div>
                <div class="duty-main">${dutyMain}</div>
                <div class="duty-details">${dutyDetails}</div>
                <div class="duty-times">${dutyTimes}</div>
                <div class="duty-category category-${dutyInfo.category}">${dutyInfo.category}</div>
            `;
            
            return card;
        }

        // Global variables for modal navigation
        let currentModalView = 'duty'; // 'duty' or 'timetable'
        let currentDutyContent = '';
        let currentDutyData = null;
        let currentDutyDate = null;
        let timetablePaths = {};
        let currentTimetableData = null;

        // Location mapping for timetables
        const locationMapping = {
            'ABR': 'Abbey Road', 'ALS': 'All Saints', 'BAN': 'Bank', 'BEC': 'Beckton', 
            'BEP': 'Beckton Park', 'BLA': 'Blackwall', 'BOC': 'Bow Church', 'CAW': 'Canary Wharf',
            'CAT': 'Canning Town', 'CRO': 'Crossharbour', 'CUH': 'Custom House', 'CUS': 'Cutty Sark',
            'CYP': 'Cyprus', 'DEB': 'Deptford Bridge', 'DER': 'Devons Road', 'EAI': 'East India',
            'ELR': 'Elverson Road', 'GAR': 'Gallions Reach', 'GRE': 'Greenwich', 'HEQ': 'Heron Quays',
            'ISG': 'Island Gardens', 'KGV': 'King George V', 'LAP': 'Langdon Park', 'LEW': 'Lewisham',
            'LIM': 'Limehouse', 'LCA': 'London City Airport', 'MUD': 'Mudchute', 'PDK': 'Pontoon Dock',
            'POP': 'Poplar', 'PRR': 'Prince Regent', 'PML': 'Pudding Mill Lane', 'ROA': 'Royal Albert',
            'ROV': 'Royal Victoria', 'SHA': 'Shadwell', 'SOQ': 'South Quay', 'STL': 'Star Lane',
            'SHS': 'Stratford High Street', 'STI': 'Stratford International', 'STR': 'Stratford',
            'TOG': 'Tower Gateway', 'WEH': 'West Ham', 'WIQ': 'West India Quay', 'WST': 'West Silvertown',
            'WES': 'Westferry', 'WOA': 'Woolwich Arsenal',
            'POD': 'Poplar Depot', 'BED': 'Beckton Depot'
        };

        // Initialize timetable paths on load
        async function initializeTimetablePaths() {
            try {
                const response = await fetch('https://raw.githubusercontent.com/dlrttbl/dlrttbl.github.io/refs/heads/main/paths.txt', { cache: 'no-store' });
                const text = await response.text();
                
                const lines = text.split('\n').filter(line => line.trim() !== '');
                
                let currentEntry = {};
                const timetableEntries = [];
                
                for (const line of lines) {
                    const trimmedLine = line.trim();
                    if (trimmedLine.startsWith('Name:')) {
                        if (Object.keys(currentEntry).length > 0) {
                            timetableEntries.push({...currentEntry});
                        }
                        currentEntry = {
                            name: trimmedLine.substring(5).trim()
                        };
                    } else if (trimmedLine.startsWith('Applies:')) {
                        currentEntry.applies = trimmedLine.substring(8).trim();
                    } else if (trimmedLine.startsWith('URL:')) {
                        currentEntry.url = trimmedLine.substring(4).trim();
                        const fileName = currentEntry.url.substring(currentEntry.url.lastIndexOf('/') + 1, currentEntry.url.lastIndexOf('.'));
                        currentEntry.fileName = fileName.toLowerCase();
                    }
                }
                
                if (Object.keys(currentEntry).length > 0) {
                    timetableEntries.push(currentEntry);
                }

                timetableEntries.forEach(entry => {
                    timetablePaths[entry.fileName] = entry;
                });
                
            } catch (error) {
                console.error('Error fetching timetable paths:', error);
            }
        }

        // Get applicable timetable for a date
        function getApplicableTimetable(date) {
            const dayNames = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
            const dayName = date.toLocaleDateString('en-US', { 
                weekday: 'long',
                timeZone: 'Europe/London'
            });
            
            for (const [fileName, timetableInfo] of Object.entries(timetablePaths)) {
                const applies = timetableInfo.applies.split(',').map(s => s.trim().replace(/['"]/g, ''));
                
                for (const range of applies) {
                    if (dayNames.includes(range) && range === dayName) {
                        return timetableInfo;
                    }
                    
                    if (range.includes('/')) {
                        const [start, end] = range.split('/').map(d => {
                            const newDate = new Date(d.trim());
                            newDate.setHours(0, 0, 0, 0);
                            return newDate;
                        });
                        const compareDate = new Date(date);
                        compareDate.setHours(0, 0, 0, 0);
                        if (compareDate >= start && compareDate <= end) {
                            return timetableInfo;
                        }
                    } else if (!dayNames.includes(range)) {
                        const rangeDate = new Date(range);
                        rangeDate.setHours(0, 0, 0, 0);
                        const compareDate = new Date(date);
                        compareDate.setHours(0, 0, 0, 0);
                        if (+compareDate === +rangeDate) {
                            return timetableInfo;
                        }
                    }
                }
            }
            
            return null;
        }

        // Fetch and parse timetable data
        async function fetchTimetableData(timetableInfo) {
            try {
                const response = await fetch(timetableInfo.url);
                const csvText = await response.text();
                
                const lines = csvText.split('\n').filter(line => line.trim() !== '');
                const runData = {};

                const junctions = [
                    'JRMS', 'JRMX', 'JCAW', 'JWEM', 'JCRO', 'JC2M', 'JC3M',
                    'JC4M', 'JROM', 'JWEX', 'JCTM', 'JCTX', 'JWIQ', 'JNQX',
                    'JNQM', 'JWSX', 'JWSM', 'ISP2', 'ISP3'
                ];

                lines.forEach((line, index) => {
                    const parts = line.split(',');
                    if (parts.length >= 7) {
                        const runNumber = parts[1].trim();
                        const locationCode = parts[4].trim();
                        const arrivalTime = parts[5].trim();
                        const departureTime = parts[6].trim();

                        if (!junctions.includes(locationCode)) {
                            if (!runData[runNumber]) {
                                runData[runNumber] = [];
                            }

                            let location = '';
                            let platform = '';

                            if (locationCode === 'BANH') {
                                location = 'Bank Headshunt';
                            } else {
                                const codePrefix = locationCode.slice(0, 3);
                                platform = locationCode.slice(3);

                                if (locationMapping[codePrefix]) {
                                    location = locationMapping[codePrefix];
                                    if (['LEW', 'BEC', 'STI', 'WOA'].includes(codePrefix) || locationCode === 'STR4B') {
                                        platform = '';
                                    }
                                } else {
                                    location = locationCode;
                                    platform = '';
                                }
                            }

                            runData[runNumber].push({
                                location,
                                platform,
                                arrivalTime,
                                departureTime,
                                locationCode
                            });
                        }
                    }
                });

                return runData;
            } catch (error) {
                console.error('Error fetching timetable data:', error);
                return null;
            }
        }

        // Filter run data by time constraints
        function filterRunByTime(runData, startTime, endTime) {
            if (!runData || !startTime || !endTime) return runData;
            
            const parseTime = (timeStr) => {
                const [hours, minutes, seconds] = timeStr.split(':').map(Number);
                return hours * 3600 + minutes * 60 + (seconds || 0);
            };
            
            const startSeconds = parseTime(startTime + ':00');
            const endSeconds = parseTime(endTime + ':00');
            
            // Find the last stop that would normally be included
            let lastIncludedIndex = -1;
            for (let i = 0; i < runData.length; i++) {
                const arrivalSeconds = parseTime(runData[i].arrivalTime);
                if (arrivalSeconds >= startSeconds && arrivalSeconds <= endSeconds) {
                    lastIncludedIndex = i;
                }
            }
            
            // If we found stops within the time range, include one additional stop beyond the last one
            if (lastIncludedIndex >= 0) {
                const endIndex = Math.min(lastIncludedIndex + 2, runData.length);
                return runData.filter((stop, index) => {
                    const arrivalSeconds = parseTime(stop.arrivalTime);
                    return (arrivalSeconds >= startSeconds && index < endIndex);
                });
            }
            
            // Fallback to original filtering if no stops found in range
            return runData.filter(stop => {
                const arrivalSeconds = parseTime(stop.arrivalTime);
                return arrivalSeconds >= startSeconds && arrivalSeconds <= endSeconds;
            });
        }

        // Add depot stops to run data
        function addDepotStops(runData, startLocation, endLocation, startTime, endTime) {
            if (!runData) return [];
            
            const result = [...runData];
            
            // Add start depot if needed
            if ((startLocation === 'POD' || startLocation === 'BED') && 
                !result.some(stop => stop.locationCode && stop.locationCode.startsWith(startLocation))) {
                result.unshift({
                    location: locationMapping[startLocation],
                    platform: '',
                    arrivalTime: '',
                    departureTime: startTime + ':00',
                    locationCode: startLocation,
                    isDepot: true
                });
            }
            
            // Add end depot if needed  
            if ((endLocation === 'POD' || endLocation === 'BED') && 
                !result.some(stop => stop.locationCode && stop.locationCode.startsWith(endLocation))) {
                result.push({
                    location: locationMapping[endLocation],
                    platform: '',
                    arrivalTime: endTime + ':00',
                    departureTime: '',
                    locationCode: endLocation,
                    isDepot: true
                });
            }
            
            return result;
        }

        // Show timetable view
        async function showTimetableView(halfName, runNumber, startTime, endTime, startLocation, endLocation, dutyDate = currentDutyDate) {
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');
            const closeBtn = document.querySelector('.close-modal');
            const dutyPane = document.getElementById('duty-pane');
            let timetablePane = document.getElementById('timetable-pane');

            // --- Slide out the duty pane to the RIGHT ---
            dutyPane.classList.remove('is-center');
            dutyPane.classList.add('is-right');

            // --- Change header details ---
            modalTitle.textContent = `${halfName}: Run ${runNumber}`;
            closeBtn.innerHTML = '';
            closeBtn.style.fontSize = '1.5rem';
            closeBtn.style.fontWeight = 'normal';
            currentModalView = 'timetable';

            // --- Prepare the timetable pane (off-screen on the LEFT) ---
            if (!timetablePane) {
                timetablePane = document.createElement('div');
                timetablePane.id = 'timetable-pane';
                timetablePane.className = 'slide-pane timetable is-left'; // Start off-screen left
                modalBody.querySelector('.slide-container').appendChild(timetablePane);
            } else {
                 timetablePane.className = 'slide-pane timetable is-left';
            }
            
            timetablePane.innerHTML = `<div style="padding: 2rem; text-align: center; color: #888;">Loading timetable...</div>`;
            
            try {
                // Get applicable timetable for the duty date
                const applicableTimetable = getApplicableTimetable(dutyDate);
                if (!applicableTimetable) throw new Error('No applicable timetable found for this date');

                // Fetch timetable data if not already cached
                if (!currentTimetableData) currentTimetableData = await fetchTimetableData(applicableTimetable);

                if (!currentTimetableData || !currentTimetableData[runNumber]) throw new Error('Run not found in timetable');

                // Get and filter run data
                let runData = currentTimetableData[runNumber];
                runData = filterRunByTime(runData, startTime, endTime);
                runData = addDepotStops(runData, startLocation, endLocation, startTime, endTime);

                // Create timetable HTML
                let timetableHTML = `
                    <table style="width: 100%; border-collapse: collapse; margin: 0; table-layout: fixed;">
                        <thead class="timetable-sticky-header">
                            <tr>
                                <th style="width: 35%; font-weight: 600; font-size: 14px; color: #888; padding: 12px; text-align: left;">Location</th>
                                <th style="width: 15%; font-weight: 600; font-size: 14px; color: #888; padding: 12px; text-align: center;">Plat.</th>
                                <th style="width: 25%; font-weight: 600; font-size: 14px; color: #888; padding: 12px; text-align: center;">Arrival</th>
                                <th style="width: 25%; font-weight: 600; font-size: 14px; color: #888; padding: 12px; text-align: center;">Departure</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                runData.forEach(stop => {
                    const isDepot = stop.isDepot || stop.locationCode === 'POD' || stop.locationCode === 'BED';
                    const rowStyle = isDepot ? 'background: rgba(30, 136, 229, 0.1);' : '';
                    const nameColor = isDepot ? 'color: #1e88e5;' : 'color: #ffffff;';
                    
                    timetableHTML += `
                        <tr style="border-bottom: 1px solid rgba(255, 255, 255, 0.05); ${rowStyle}">
                            <td style="padding: 12px; font-weight: 500; font-size: 14px; ${nameColor} vertical-align: middle;">${stop.location}</td>
                            <td style="padding: 12px; color: #888; font-size: 14px; text-align: center; vertical-align: middle;">${stop.platform}</td>
                            <td style="padding: 12px; font-family: 'Courier New', monospace; font-weight: bold; color: #667eea; font-size: 14px; text-align: center; vertical-align: middle;">${stop.arrivalTime}</td>
                            <td style="padding: 12px; font-family: 'Courier New', monospace; font-weight: bold; color: #667eea; font-size: 14px; text-align: center; vertical-align: middle;">${stop.departureTime}</td>
                        </tr>
                    `;
                });

                timetableHTML += `</tbody></table>`;
                timetablePane.innerHTML = timetableHTML;
                
            } catch (error) {
                console.error('Error loading timetable:', error);
                timetablePane.innerHTML = `<div style="padding: 2rem; text-align: center; color: #e53935;">${error.message}</div>`;
            }

            // --- Slide in the new pane from the LEFT ---
            requestAnimationFrame(() => {
                 timetablePane.classList.remove('is-left');
                 timetablePane.classList.add('is-center');
            });
        }

        // Check if duty is base type (can show timetable)
        function isDutyBaseType(versionInfo) {
            return versionInfo.type === 'base';
        }

        // Show duty details modal
        function showDutyDetails(versionInfo, dutyNumber) {
            const modal = document.getElementById('dutyModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');
            
            currentDutyData = versionInfo;
            currentTimetableData = null; 
            
            const duty = versionInfo.duty;
            const dutyId = versionInfo.dutyId;
            const [number, location, endLocation, startTime, endTime] = dutyId.split('-');
            
            modalTitle.textContent = `Duty ${number}: ${location} ${startTime}-${endTime}`;
            
            const isBaseDuty = isDutyBaseType(versionInfo);
            
            let dutyContentHTML = `
                <div class="section">
                    <div class="section-item">
                        <span class="section-label">Type:</span>
                        <span>${duty.TypeOfDuty}</span>
                    </div>
                    <div class="section-item">
                        <span class="section-label">Spread:</span>
                        <span>${duty.Spreadtime}</span>
                    </div>
                    <div class="section-item">
                        <span class="section-label">Paid:</span>
                        <span>${duty.PaidTime}</span>
                    </div>
                    <div class="section-item">
                        <span class="section-label">Book on:</span>
                        <span>${startTime}${location ? ` at ${location}` : ''}</span>
                    </div>
                </div>
            `;

            if (duty.TypeOfDuty === "SPARE" || duty.TypeOfDuty === "TRAINING" || duty.TypeOfDuty === "PANEL") {
                dutyContentHTML += `<div class="section"><div class="section-header">Duty Details</div><div style="margin-left: 1rem; font-style: italic; color: #888;">${duty.TypeOfDuty}</div></div>`;
            } else {
                const canShowFirstHalf = isBaseDuty && duty.FirstHalfRunNumber && duty.FirstHalfRunNumber !== "" && duty.FirstHalfRunNumber !== "TR";
                const dutyDateString = currentDutyDate.getFullYear() + ',' + (currentDutyDate.getMonth()) + ',' + currentDutyDate.getDate();
                
                dutyContentHTML += `
                    <div class="section">
                        <div class="section-header">
                            <div style="display: flex; align-items: center; justify-content: space-between; width: 100%; ${canShowFirstHalf ? 'cursor: pointer;' : ''}" ${canShowFirstHalf ? `onclick="showTimetableView('First Half', '${duty.FirstHalfRunNumber}', '${duty.FirstHalfStartTime}', '${duty.FirstHalfEndTime}', '${duty.FirstHalfStartLocation}', '${duty.FirstHalfEndLocation}', new Date(${dutyDateString}))"` : ''}>
                                <span>First Half (${duty.FirstHalfLength})</span>
                                ${canShowFirstHalf ? '<div style="display: flex; align-items: center; gap: 8px; font-size: 12px; color: #888;">View Calling Points </div>' : ''}
                            </div>
                        </div>`;

                if (duty.FirstHalfRunNumber === "" || duty.FirstHalfRunNumber === "TR") {
                    dutyContentHTML += `<div style="margin-left: 1rem; font-style: italic; color: #888;">${duty.TypeOfDuty}</div>`;
                } else {
                    dutyContentHTML += `<div style="margin-left: 1rem;"><div class="section-item"><span class="section-label">Run:</span><span>${duty.FirstHalfRunNumber}</span></div><div class="section-item"><span class="section-label">Pick up:</span><span>${duty.FirstHalfStartLocation} at ${duty.FirstHalfStartTime}</span></div><div class="section-item"><span class="section-label">Relieved:</span><span>${duty.FirstHalfEndLocation} at ${duty.FirstHalfEndTime}</span></div></div>`;
                }
                dutyContentHTML += `</div>`;

                if (duty.FirstHalfEndTime && duty.SecondHalfStartTime) {
                    dutyContentHTML += `<div class="section"><div class="section-header">Break Details</div><div class="section-item"><span class="section-label">Duration:</span><span>${calculateBreakDetails(duty)}</span></div></div>`;
                }

                const canShowSecondHalf = isBaseDuty && duty.SecondHalfRunNumber && duty.SecondHalfRunNumber !== "" && duty.SecondHalfRunNumber !== "TR";
                dutyContentHTML += `
                    <div class="section">
                         <div class="section-header">
                            <div style="display: flex; align-items: center; justify-content: space-between; width: 100%; ${canShowSecondHalf ? 'cursor: pointer;' : ''}" ${canShowSecondHalf ? `onclick="showTimetableView('Second Half', '${duty.SecondHalfRunNumber}', '${duty.SecondHalfStartTime}', '${duty.SecondHalfEndTime}', '${duty.SecondHalfStartLocation}', '${duty.SecondHalfEndLocation}', new Date(${dutyDateString}))"` : ''}>
                                <span>Second Half (${duty.SecondHalfLength})</span>
                                ${canShowSecondHalf ? '<div style="display: flex; align-items: center; gap: 8px; font-size: 12px; color: #888;">View Calling Points </div>' : ''}
                            </div>
                        </div>`;

                if (duty.SecondHalfRunNumber === "" || duty.SecondHalfRunNumber === "TR") {
                    dutyContentHTML += `<div style="margin-left: 1rem; font-style: italic; color: #888;">${duty.TypeOfDuty}</div>`;
                } else {
                     dutyContentHTML += `<div style="margin-left: 1rem;"><div class="section-item"><span class="section-label">Run:</span><span>${duty.SecondHalfRunNumber}</span></div><div class="section-item"><span class="section-label">Pick up:</span><span>${duty.SecondHalfStartLocation} at ${duty.SecondHalfStartTime}</span></div><div class="section-item"><span class="section-label">Relieved:</span><span>${duty.SecondHalfEndLocation} at ${duty.SecondHalfEndTime}</span></div></div>`;
                }
                dutyContentHTML += `</div>`;
            }

            dutyContentHTML += `<div class="section"><div class="section-item"><span class="section-label">Book off:</span><span>${endTime}${endLocation ? ` at ${endLocation}` : ''}</span></div></div>`;

            modalBody.innerHTML = `
                <div class="slide-container">
                    <div id="duty-pane" class="slide-pane is-center">${dutyContentHTML}</div>
                </div>
            `;
            
            modal.style.display = 'flex';
            modal.classList.add('modal-opening');
            
            history.pushState({ modal: 'duty' }, '', '');
        }

        // Calculate break details
        function calculateBreakDetails(duty) {
            if (!duty.FirstHalfEndTime || !duty.SecondHalfStartTime) return "N/A";

            const [breakHours, breakMins] = calculateTimeDifference(
                duty.FirstHalfEndTime,
                duty.SecondHalfStartTime
            ).split(':').map(Number);

            const [mealHours, mealMins] = duty.MealBreakDuration.split(':').map(Number);
            
            const totalBreakMins = (breakHours * 60 + breakMins);
            const mealBreakMins = (mealHours * 60 + mealMins);
            const paidBreakMins = totalBreakMins - mealBreakMins;
            
            const paidHours = Math.floor(paidBreakMins / 60);
            const paidMins = paidBreakMins % 60;
            const paidBreak = `${paidHours.toString().padStart(2, '0')}:${paidMins.toString().padStart(2, '0')}`;

            return `${formatTime(breakHours, breakMins)} (${duty.MealBreakDuration} unpaid + ${paidBreak} paid)`;
        }

        function calculateTimeDifference(time1, time2) {
            const [h1, m1] = time1.split(':').map(Number);
            const [h2, m2] = time2.split(':').map(Number);
            
            let diffMinutes = (h2 * 60 + m2) - (h1 * 60 + m1);
            if (diffMinutes < 0) diffMinutes += 24 * 60;
            
            const hours = Math.floor(diffMinutes / 60);
            const minutes = diffMinutes % 60;
            return formatTime(hours, minutes);
        }

        function formatTime(hours, minutes) {
            return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
        }

        // Close modal or navigate back
        function closeDutyModal() {
            const modal = document.getElementById('dutyModal');
            const modalTitle = document.getElementById('modalTitle');
            const closeBtn = document.querySelector('.close-modal');

            if (currentModalView === 'timetable') {
                const dutyPane = document.getElementById('duty-pane');
                const timetablePane = document.getElementById('timetable-pane');
                
                // Animate timetable out to the LEFT
                timetablePane.classList.remove('is-center');
                timetablePane.classList.add('is-left');
                
                // Animate duty details back in from the RIGHT
                dutyPane.classList.remove('is-right');
                dutyPane.classList.add('is-center');

                // Restore header details
                const { dutyId } = currentDutyData;
                const [number, location, , startTime, endTime] = dutyId.split('-');
                modalTitle.textContent = `Duty ${number}: ${location} ${startTime}-${endTime}`;
                closeBtn.innerHTML = '&times;';
                closeBtn.style.fontSize = '1.5rem';
                closeBtn.style.fontWeight = 'normal';
                currentModalView = 'duty';
            } else {
                // Close the entire modal
                modal.classList.add('modal-closing');
                modal.classList.remove('modal-opening');
                setTimeout(() => {
                    modal.style.display = 'none';
                    modal.classList.remove('modal-closing');
                    currentModalView = 'duty';
                    currentDutyData = null;
                }, 200); // Match FASTER animation duration
            }
        }

        // Handle browser back button
        window.addEventListener('popstate', (event) => {
            const modal = document.getElementById('dutyModal');
            if (modal && modal.style.display === 'flex') {
                closeDutyModal();
            }
        });

        // Close modal when clicking outside (on the backdrop)
        document.getElementById('dutyModal').addEventListener('click', (e) => {
            if (e.target.id === 'dutyModal') {
                closeDutyModal();
            }
        });

        // Show error
        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        // Initialize
        createParticles();
        
    </script>

    <!-- Firebase SDK Loader -->
    <script>
        function loadFirebase() {
            const loadScript = (src, callback) => {
                const script = document.createElement('script');
                script.src = src;
                script.onload = callback;
                document.body.appendChild(script);
            };
            
            loadScript('https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js', () => {
                loadScript('https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js', () => {
                    loadScript('https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js', () => {
                        const firebaseConfig = {
                            apiKey: "AIzaSyBkKclvdWHVQ58IFG_ap0ByJA_2a8J2YXU",
                            authDomain: "owngoal-4f34f.firebaseapp.com",
                            projectId: "owngoal-4f34f",
                            storageBucket: "owngoal-4f34f.firebasestorage.app",
                            messagingSenderId: "270078133518",
                            appId: "1:270078133518:web:36ef7431fda632bed1c35f"
                        };
                        firebase.initializeApp(firebaseConfig);
                        
                        firebase.auth().setPersistence(firebase.auth.Auth.Persistence.LOCAL)
                            .catch(error => {
                                console.error("Persistence error:", error);
                            });
                        
                        firebase.auth().onAuthStateChanged((user) => {
                            if (user) {
                                console.log('User is signed in:', user.email);
                                initializeApp();
                            } else {
                                console.log('User is signed out.');
                                loginSplashScreen.style.display = 'flex';
                                loginSplashScreen.style.opacity = '1';
                                mainContainer.style.display = 'none';
                                loginButton.disabled = false;
                                
                                const loadingOverlay = document.getElementById('loadingOverlay');
                                const textOverlay = document.getElementById('textOverlay');
                                if (loadingOverlay) {
                                    loadingOverlay.style.display = 'flex';
                                    loadingOverlay.style.opacity = '1';
                                }
                                if (textOverlay) {
                                    textOverlay.style.display = 'block';
                                    textOverlay.style.opacity = '1';
                                }
                            }
                        });
                        
                    });
                });
            });
        }
        loadFirebase();
    </script>
</body>
</html>
