<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Duty Calendar - Where is Omari?</title>
    <link rel="stylesheet" href="shared-styles.css">
    <style>
        /* Calendar-specific styles */
        .container {
            position: relative;
            z-index: 10;
            min-height: 100vh;
            display: none;
            flex-direction: column;
            padding: 2rem;
            max-width: 1200px;
            margin: 0 auto;
        }

        /* Header */
        .header {
            text-align: center;
            margin-bottom: 3rem;
            position: relative;
        }
        
        .page-title {
            font-size: clamp(2rem, 6vw, 3.5rem);
            font-weight: 300;
            margin-bottom: 1rem;
            line-height: 1.2;
        }

        .title-gradient {
            background: linear-gradient(to right, hsl(300, 80%, 70%), hsl(270, 80%, 61%), hsl(235, 85%, 55%), hsl(300, 80%, 70%));
            background-size: 300% 300%;
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: gradientCycle 5s linear infinite;
        }

        .title-white {
            color: #ffffff;
        }

        /* Calendar grid */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .duty-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .duty-card:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        .duty-card.rest-day {
            cursor: default;
        }

        .duty-card.rest-day:hover {
            transform: none;
        }

        .duty-date {
            font-size: 0.9rem;
            color: #888;
            margin-bottom: 0.5rem;
        }

        .duty-main {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #ffffff;
        }

        .duty-details {
            font-size: 0.9rem;
            color: #ccc;
            margin-bottom: 1rem;
        }

        .duty-times {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            color: #888;
        }

        .duty-category {
            position: absolute;
            top: 12px;
            right: 12px;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 600;
        }

        /* Category colors */
        .category-AL { background: #22330B; }
        .category-BH { background: #2B1710; }
        .category-E { background: #004659; }
        .category-EE { background: #004659; }
        .category-EM { background: #003939; }
        .category-IT { background: #80215D; }
        .category-L { background: #002039; }
        .category-LD { background: #5E2405; }
        .category-LL { background: #002039; }
        .category-M { background: #003939; }
        .category-ML { background: #003939; }
        .category-MRD { background: #063004; }
        .category-O { background: #063004; }
        .category-OAL { background: #22330B; }
        .category-OT { background: #6E0811; }
        .category-RD { background: #063004; }
        .category-Swap { background: #3A2F00; }
        .category-T { background: #80215D; }

        /* Responsive design */
        @media (max-width: 768px) {
            .container {
                min-height: 85vh;
                padding: 70px 1rem 2rem 1rem;
            }
            
            .header {
                margin-bottom: 2rem;
            }
            
            .calendar-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            .page-title {
                font-size: clamp(2.5rem, 8vw, 4rem);
                margin-bottom: 0.5rem;
            }
        }
    </style>
</head>
<body>
    <!-- Enhanced particle background -->
    <div class="particles" id="particles"></div>
    
    <!-- Particle mask to hide stuck particles at top -->
    <div class="particle-mask"></div>
    
    <!-- Login Screen -->
    <div class="login-splash-screen" id="loginSplashScreen" style="display: none;">
        <div class="login-content">
            <div id="loginForm">
                <input type="password" id="passwordInput" class="login-input" placeholder="Password">
                <button id="loginButton" class="login-button" onclick="signIn()">Sign In</button>
                <div id="loginError" class="login-error"></div>
            </div>
        </div>
    </div>
    
    <!-- Text overlay to hide content during loading -->
    <div class="text-overlay" id="textOverlay"></div>
    
    <!-- Loading overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="simple-loader"></div>
    </div>

    <!-- Navigation buttons outside container -->
    <a href="/" class="nav-link" id="realtimeNavButton" style="display: none;">View Realtime</a>
    <button id="signOutButton" class="sign-out-link" onclick="signOut()" style="display: none;">Sign Out</button>

    <!-- Main content -->
    <div class="container" id="mainContainer" style="display: none;">
        <div class="header">
            <h1 class="page-title">
                <span class="title-gradient">Omari's</span><br>
                <span class="title-white">Duty Calendar</span>
            </h1>
        </div>
        
        <div class="calendar-grid" id="calendarGrid">
            <!-- Calendar items will be populated here -->
        </div>
        
        <div id="errorMessage" class="error-message" style="display: none;"></div>
    </div>

    <!-- Include shared JavaScript files -->
    <script src="shared-utils.js"></script>
    <script src="shared-particles.js"></script>
    <script src="shared-auth.js"></script>
    <script src="shared-duty-logic.js"></script>
    <script src="shared-modal.js"></script>

    <script>
        // Data storage
        let dutyData = null; // Changed from dutyTrackerData to dutyData
        let currentTimetableData = null;
        let currentDutyDate = null; // Missing global variable declaration

        // Initialize app after login
        function initializeApp() {
            // Show loading overlay
            document.getElementById('loadingOverlay').style.display = 'flex';
            document.getElementById('loadingOverlay').style.opacity = '1';
            
            console.log('initializeApp called for user:', firebase.auth().currentUser?.email);
            
            loginSplashScreen.style.opacity = '0';
            setTimeout(() => {
                loginSplashScreen.style.display = 'none';
            }, 500);

            // Show main container immediately
            mainContainer.style.display = 'flex';
            
            // Load duty tracker, duty lookup data, and initialize modal functionality
            Promise.all([
                fetchDutyTracker().then(data => { 
                    dutyData = data || window.dutyData; // Handle both return value and global assignment
                }),
                fetchDutyLookupData(),
                initializeModalFunctionality() // This includes initializeTimetablePaths()
            ])
            .then(() => {
                console.log('All data loaded successfully');
                populateCalendar();
                
                // Fade out overlays
                setTimeout(() => {
                    const loadingOverlay = document.getElementById('loadingOverlay');
                    if (loadingOverlay) {
                        loadingOverlay.style.opacity = '0';
                        setTimeout(() => {
                            loadingOverlay.style.display = 'none';
                        }, 800);
                    }
                }, 3200);
                
                setTimeout(() => {
                    const textOverlay = document.getElementById('textOverlay');
                    if (textOverlay) {
                        textOverlay.style.opacity = '0';
                        setTimeout(() => {
                            textOverlay.style.display = 'none';
                            // Show nav buttons when content is fully visible
                            document.getElementById('realtimeNavButton').style.display = 'block';
                            document.getElementById('signOutButton').style.display = 'block';
                        }, 800);
                    }
                }, 4000);
            })
            .catch(error => {
                console.error("Data loading failed:", error);
                showError('Error loading duty data: ' + error.message);
                
                // Hide overlays even on error
                setTimeout(() => {
                    const loadingOverlay = document.getElementById('loadingOverlay');
                    const textOverlay = document.getElementById('textOverlay');
                    if (loadingOverlay) loadingOverlay.style.display = 'none';
                    if (textOverlay) textOverlay.style.display = 'none';
                }, 2000);
            });
        }

        // Parse duty tracker to get next 21 days
        function parseNext21Days() {
            if (!dutyData) return []; // Changed from dutyTrackerData to dutyData
            
            const lines = dutyData.split('\n'); // Changed from dutyTrackerData to dutyData
            const duties = [];
            const startDate = getOperatingDate();
            
            let dateCount = 0;
            let i = 0;
            
            // Find starting date
            while (i < lines.length && dateCount < 21) {
                const line = lines[i].trim();
                if (line.endsWith(':')) {
                    const date = line.slice(0, -1);
                    
                    if (date >= startDate) {
                        const category = lines[i + 1]?.trim();
                        const dutyNumber = lines[i + 2]?.trim();
                        
                        let firstHalf = '';
                        let secondHalf = '';
                        
                        if (category && !['O', 'AL', 'OAL', 'LD', 'BH', 'RD', 'MRD'].includes(category)) {
                            firstHalf = lines[i + 3]?.trim() || '';
                            secondHalf = lines[i + 4]?.trim() || '';
                        }
                        
                        duties.push({
                            date,
                            category,
                            dutyNumber,
                            firstHalf,
                            secondHalf
                        });
                        
                        dateCount++;
                    }
                }
                i++;
            }
            
            return duties;
        }

        // Populate calendar
        function populateCalendar() {
            const duties = parseNext21Days();
            const grid = document.getElementById('calendarGrid');
            
            if (duties.length === 0) {
                showError('No duty data found');
                return;
            }
            
            grid.innerHTML = '';
            
            duties.forEach(dutyInfo => {
                const card = createDutyCard(dutyInfo);
                grid.appendChild(card);
            });
        }

        // Create duty card
        function createDutyCard(dutyInfo) {
            const card = document.createElement('div');
            card.className = 'duty-card';
            
            const date = new Date(dutyInfo.date);
            const dateStr = date.toLocaleDateString('en-GB', { 
                weekday: 'long', 
                day: 'numeric', 
                month: 'long', 
                year: 'numeric' 
            });
            
            const dayNames = {
                "O": "Rest day",
                "AL": "Annual leave",
                "OAL": "Owed annual leave",
                "LD": "Lieu day",
                "BH": "Bank holiday",
                "RD": "Rest day",
                "MRD": "Rest day",
                "IT": "Training",
                "T": "Training",
                "Swap": "Swap duty"
            };
            
            // Check if this is a non-working day
            const nonWorkingCategories = ['O', 'AL', 'OAL', 'LD', 'BH', 'RD', 'MRD'];
            if (nonWorkingCategories.includes(dutyInfo.category)) {
                card.classList.add('rest-day');
                
                // Set the card background to the category color with transparency
                const categoryColors = {
                    "AL": "rgba(34, 51, 11, 0.7)",
                    "BH": "rgba(43, 23, 16, 0.7)", 
                    "E": "rgba(0, 70, 89, 0.7)",
                    "EE": "rgba(0, 70, 89, 0.7)",
                    "EM": "rgba(0, 57, 57, 0.7)",
                    "IT": "rgba(128, 33, 93, 0.7)",
                    "L": "rgba(0, 32, 57, 0.7)",
                    "LD": "rgba(94, 36, 5, 0.7)",
                    "LL": "rgba(0, 32, 57, 0.7)",
                    "M": "rgba(0, 57, 57, 0.7)",
                    "ML": "rgba(0, 57, 57, 0.7)",
                    "MRD": "rgba(6, 48, 4, 0.7)",
                    "O": "rgba(6, 48, 4, 0.7)",
                    "OAL": "rgba(34, 51, 11, 0.7)",
                    "OT": "rgba(110, 8, 17, 0.7)",
                    "RD": "rgba(6, 48, 4, 0.7)",
                    "Swap": "rgba(58, 47, 0, 0.7)",
                    "T": "rgba(128, 33, 93, 0.7)"
                };
                
                card.style.background = categoryColors[dutyInfo.category] || 'rgba(51, 51, 51, 0.7)';
                
                card.innerHTML = `
                    <div class="duty-date">${dateStr}</div>
                    <div class="duty-main">${dayNames[dutyInfo.category] || dutyInfo.category}</div>
                    <div class="duty-category category-${dutyInfo.category}">${dutyInfo.category}</div>
                `;
                return card;
            }
            
            // Working duty
            let dutyMain = '';
            let dutyDetails = '';
            let dutyTimes = '';
            
            if (dutyInfo.dutyNumber) {
                // Try to get duty details from lookup data
                const versions = getDutyForDate(dutyInfo.dutyNumber, dutyInfo.date);
                if (versions.length > 0) {
                    const dutyId = versions[0].dutyId;
                    const parts = dutyId.split('-');
                    const location = parts[1];
                    const startTime = parts[3];
                    const endTime = parts[4];
                    
                    dutyMain = `Duty ${dutyInfo.dutyNumber}`;
                    dutyDetails = `${location} ${startTime}-${endTime}`;
                    dutyTimes = `<span>Book on: ${startTime}</span><span>Book off: ${endTime}</span>`;
                    
                    card.addEventListener('click', () => {
                        const dutyDateParts = dutyInfo.date.split('-');
                        currentDutyDate = new Date(dutyDateParts[0], dutyDateParts[1] - 1, dutyDateParts[2]);
                        
                        currentTimetableData = null;
                        showDutyDetails(versions[0], dutyInfo.dutyNumber, currentDutyDate);
                    });
                } else {
                    dutyMain = `Duty ${dutyInfo.dutyNumber}`;
                    dutyDetails = 'Details not available';
                }
            } else {
                dutyMain = dutyInfo.category;
                dutyDetails = 'Working duty';
            }
            
            card.innerHTML = `
                <div class="duty-date">${dateStr}</div>
                <div class="duty-main">${dutyMain}</div>
                <div class="duty-details">${dutyDetails}</div>
                <div class="duty-times">${dutyTimes}</div>
                <div class="duty-category category-${dutyInfo.category}">${dutyInfo.category}</div>
            `;
            
            return card;
        }

        // Initialize particles and add event handlers
        createParticles();

        // Initialize auth elements and load Firebase
        initializeAuthElements();

        loadFirebase({
            onSignedIn: initializeApp,
            onSignedOut: function() {
                // Any page-specific sign out handling
            }
        });
    </script>
</body>
</html>